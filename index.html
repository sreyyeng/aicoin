<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI加密货币交易顾问 Pro v2.3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .auto-refresh-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .auto-refresh-badge.active {
            background: rgba(40, 167, 69, 0.3);
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .tab-container {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .last-update {
            font-size: 0.7em;
            color: #6c757d;
            font-weight: normal;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .position-details {
            display: none;
            animation: fadeIn 0.3s;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
            min-width: 200px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
            flex: 1;
            min-width: 200px;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .data-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .data-item.updating {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .data-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
        }

        .data-value.positive {
            color: #28a745;
        }

        .data-value.negative {
            color: #dc3545;
        }

        .ai-advice {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border: 3px solid #667eea;
        }

        .ai-advice-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .ai-icon {
            font-size: 2.5em;
        }

        .ai-advice-title {
            font-size: 1.8em;
            color: #667eea;
            font-weight: 700;
        }

        .advice-content {
            line-height: 1.8;
            font-size: 1.05em;
            color: #333;
            white-space: pre-wrap;
        }

        .signal-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1em;
            margin: 10px 0;
        }

        .signal-buy {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .signal-sell {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .signal-hold {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .signal-wait {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #17a2b8;
        }

        .chart-container {
            margin: 30px 0;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chart-tab {
            padding: 10px 20px;
            background: #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .chart-tab.active {
            background: #667eea;
            color: white;
        }

        .config-section {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .config-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 10px;
        }

        .coin-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .coin-chip {
            padding: 10px 20px;
            background: #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .coin-chip:hover {
            background: #dee2e6;
        }

        .coin-chip.selected {
            background: #667eea;
            color: white;
            border-color: #5568d3;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .coin-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .coin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .coin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .coin-name {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .coin-signal {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .score-container {
            text-align: center;
            margin: 20px 0;
        }

        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: 700;
            margin: 0 auto;
        }

        .score-label {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 10px;
        }

        .backtest-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .backtest-metric {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .backtest-metric-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .backtest-metric-value {
            font-size: 1.8em;
            font-weight: 700;
        }

        .trade-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .trade-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trade-item.profit {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .trade-item.loss {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        .refresh-control {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .refresh-control-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .refresh-settings {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .ai-provider-selector {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
        }

        .provider-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .provider-option:hover {
            background: #f8f9fa;
        }

        .provider-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .provider-label {
            font-weight: 600;
            font-size: 1.05em;
        }

        .provider-desc {
            font-size: 0.85em;
            color: #6c757d;
            margin-left: 30px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .tab {
                font-size: 0.9em;
                padding: 15px 10px;
            }

            .auto-refresh-badge {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI加密货币交易顾问 Pro v2.3</h1>
            <p>双AI模型 | 多级止盈止损 | 精准建议 | 自动更新</p>
            <div class="auto-refresh-badge" id="autoRefreshBadge">
                <div class="pulse"></div>
                <span id="refreshStatus">自动更新已停止</span>
            </div>
        </div>

        <div class="tab-container">
            <div class="tab active" onclick="switchTab('single')">
                📊 单币种分析
            </div>
            <div class="tab" onclick="switchTab('multi')">
                🔍 多币种雷达
            </div>
            <div class="tab" onclick="switchTab('backtest')">
                📈 历史回测
            </div>
        </div>

        <!-- 单币种分析 -->
        <div id="tab-single" class="tab-content active">
            <div class="section">
                <div class="section-title">⚙️ API配置</div>
                <div class="config-section">
                    <div class="config-title">📌 使用说明</div>
                    <p>选择AI服务商并输入API Key。支持DeepSeek和阿里云千问。</p>
                </div>

                <!-- AI服务商选择 -->
                <div class="ai-provider-selector">
                    <div class="provider-option" onclick="selectProvider('deepseek')">
                        <input type="radio" name="aiProvider" id="providerDeepseek" value="deepseek" checked>
                        <label for="providerDeepseek" class="provider-label">🔵 DeepSeek</label>
                    </div>
                    <div class="provider-desc">推理能力强，成本低（¥0.001/千tokens）</div>
                    
                    <div class="provider-option" onclick="selectProvider('qwen')" style="margin-top: 10px;">
                        <input type="radio" name="aiProvider" id="providerQwen" value="qwen">
                        <label for="providerQwen" class="provider-label">🟠 阿里云千问</label>
                    </div>
                    <div class="provider-desc">中文优化，响应快（¥0.002/千tokens）</div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            <span id="apiKeyLabel">DeepSeek API Key</span>
                        </label>
                        <input type="password" id="apiKey" placeholder="必填：sk-xxxxxx" required>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">📊 交易配置</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>币种代码</label>
                        <input type="text" id="symbol" placeholder="例如: BTC" value="BTC" required>
                    </div>
                    <div class="form-group">
                        <label>交易类型</label>
                        <select id="tradeType">
                            <option value="SWAP">永续合约</option>
                            <option value="SPOT">现货</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>持仓状态</label>
                        <select id="positionStatus" onchange="togglePositionDetails()">
                            <option value="none">未持仓</option>
                            <option value="long">已持仓 - 做多</option>
                            <option value="short">已持仓 - 做空</option>
                        </select>
                    </div>
                </div>

                <div id="positionDetails" class="position-details">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>开仓价格 (USDT)</label>
                            <input type="number" id="entryPrice" placeholder="例如: 42000" step="0.0001">
                        </div>
                        <div class="form-group">
                            <label>持仓数量</label>
                            <input type="number" id="positionSize" placeholder="例如: 0.5" step="0.0001">
                        </div>
                        <div class="form-group">
                            <label>杠杆倍数</label>
                            <input type="number" id="leverage" placeholder="例如: 10" value="10" min="1" max="125">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="startMonitoring()" id="startBtn">
                        🚀 开始监控
                    </button>
                    <button class="btn btn-primary" onclick="triggerAIAnalysis()" id="aiBtn" disabled>
                        🤖 获取AI建议
                    </button>
                    <button class="btn btn-warning" onclick="stopMonitoring()" id="stopBtn" disabled>
                        ⏹️ 停止监控
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()">
                        🔄 重置
                    </button>
                </div>
            </div>

            <div class="refresh-control" id="refreshControl" style="display: none;">
                <div class="refresh-control-title">🔄 自动更新设置</div>
                <div class="refresh-settings">
                    <div class="switch-container">
                        <label class="switch">
                            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
                            <span class="slider"></span>
                        </label>
                        <span>自动更新市场数据</span>
                    </div>
                    <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin: 0;">
                        <label style="margin: 0;">更新间隔:</label>
                        <select id="refreshInterval" style="width: auto;" onchange="updateRefreshInterval()">
                            <option value="60">1分钟</option>
                            <option value="180">3分钟</option>
                            <option value="300" selected>5分钟</option>
                            <option value="600">10分钟</option>
                        </select>
                    </div>
                    <div style="color: #6c757d; font-size: 0.9em;">
                        <span id="nextUpdateTime">下次更新: --</span>
                    </div>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="color: #667eea; font-size: 1.2em; font-weight: 600;">正在获取市场数据...</p>
            </div>

            <div id="results" class="results">
                <div class="section">
                    <div class="section-title">
                        <span>📈 实时市场数据</span>
                        <span class="last-update" id="lastUpdate">最后更新: --</span>
                    </div>
                    <div class="data-card">
                        <div class="data-grid" id="marketData"></div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">📊 价格走势图（多时间框架）</div>
                    <div class="chart-tabs">
                        <div class="chart-tab active" onclick="switchChartTimeframe('1H')">1小时K线</div>
                        <div class="chart-tab" onclick="switchChartTimeframe('4H')">4小时K线</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">🔬 技术指标分析（多时间框架）</div>
                    <div style="margin-bottom: 15px; font-weight: 600; color: #667eea;">1小时级别指标：</div>
                    <div class="data-card">
                        <div class="data-grid" id="indicators1H"></div>
                    </div>
                    <div style="margin: 25px 0 15px 0; font-weight: 600; color: #667eea;">4小时级别指标：</div>
                    <div class="data-card">
                        <div class="data-grid" id="indicators4H"></div>
                    </div>
                </div>

                <div class="ai-advice" id="aiAdviceSection" style="display: none;">
                    <div class="ai-advice-header">
                        <span class="ai-icon">🤖</span>
                        <div>
                            <div class="ai-advice-title"><span id="aiProviderName">DeepSeek</span> AI 交易建议</div>
                            <small style="color: #6c757d;">多时间框架 + 多级止盈止损 | <span id="aiUpdateTime">--</span></small>
                        </div>
                    </div>
                    <div class="advice-content" id="aiAdvice"></div>
                </div>
            </div>
        </div>

        <!-- 多币种雷达 -->
        <div id="tab-multi" class="tab-content">
            <div class="section">
                <div class="section-title">🔍 多币种雷达扫描</div>
                <div class="config-section">
                    <div class="config-title">💡 功能说明</div>
                    <p>一键扫描多个币种，通过技术指标评分找出最佳交易机会。</p>
                </div>

                <div class="form-group">
                    <label>选择要扫描的币种（可多选）</label>
                    <div class="coin-selector" id="coinSelector"></div>
                </div>

                <div class="form-group">
                    <label>交易类型</label>
                    <select id="multiTradeType">
                        <option value="SWAP">永续合约</option>
                        <option value="SPOT">现货</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="startRadarScan()">
                        🎯 开始雷达扫描
                    </button>
                </div>
            </div>

            <div id="radarLoading" class="loading">
                <div class="spinner"></div>
                <p style="color: #667eea; font-size: 1.2em; font-weight: 600;">正在扫描币种...</p>
                <p style="color: #6c757d; margin-top: 10px;" id="scanProgress">0/0</p>
            </div>

            <div id="radarResults" class="results">
                <div class="section">
                    <div class="section-title">📊 扫描结果（按评分排序）</div>
                    <div class="comparison-grid" id="comparisonGrid"></div>
                </div>
            </div>
        </div>

        <!-- 历史回测 -->
        <div id="tab-backtest" class="tab-content">
            <div class="section">
                <div class="section-title">📈 历史回测</div>
                <div class="config-section">
                    <div class="config-title">💡 功能说明</div>
                    <p>基于历史数据模拟交易策略表现。</p>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>币种代码</label>
                        <input type="text" id="backtestSymbol" placeholder="例如: BTC" value="BTC">
                    </div>
                    <div class="form-group">
                        <label>回测周期</label>
                        <select id="backtestPeriod">
                            <option value="7">最近7天</option>
                            <option value="30" selected>最近30天</option>
                            <option value="90">最近90天</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>初始资金 (USDT)</label>
                        <input type="number" id="backtestCapital" value="10000" min="100">
                    </div>
                    <div class="form-group">
                        <label>每次仓位比例</label>
                        <select id="backtestPosition">
                            <option value="0.25">25%</option>
                            <option value="0.5" selected>50%</option>
                            <option value="0.75">75%</option>
                            <option value="1">100%</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startBacktest()">
                        🚀 开始回测
                    </button>
                </div>
            </div>

            <div id="backtestLoading" class="loading">
                <div class="spinner"></div>
                <p style="color: #667eea; font-size: 1.2em; font-weight: 600;">正在回测历史数据...</p>
            </div>

            <div id="backtestResults" class="results">
                <div class="section">
                    <div class="section-title">📊 回测结果摘要</div>
                    <div class="backtest-summary" id="backtestSummary"></div>
                </div>

                <div class="section">
                    <div class="section-title">📈 权益曲线</div>
                    <div class="chart-container">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">📝 交易记录</div>
                    <div class="trade-list" id="tradeList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let priceChart = null;
        let equityChart = null;
        let currentChartData = null;
        let currentTimeframe = '1H';
        let autoRefreshTimer = null;
        let isMonitoring = false;
        let lastMarketData = null;
        let nextUpdateTimeout = null;
        let currentAIProvider = 'deepseek';

        const popularCoins = ['BTC', 'ETH', 'SOL', 'BNB', 'XRP', 'DOGE', 'ADA', 'AVAX', 'DOT', 'MATIC', 'LINK', 'UNI', 'ATOM', 'LTC', 'BCH'];

        // AI服务商选择
        function selectProvider(provider) {
            currentAIProvider = provider;
            document.getElementById('providerDeepseek').checked = (provider === 'deepseek');
            document.getElementById('providerQwen').checked = (provider === 'qwen');
            
            const label = document.getElementById('apiKeyLabel');
            const input = document.getElementById('apiKey');
            
            if (provider === 'deepseek') {
                label.textContent = 'DeepSeek API Key';
                input.placeholder = '必填：sk-xxxxxx';
                document.getElementById('aiProviderName').textContent = 'DeepSeek';
            } else {
                label.textContent = '阿里云千问 API Key';
                input.placeholder = '必填：sk-xxxxxx (阿里云)';
                document.getElementById('aiProviderName').textContent = '千问';
            }
            
            const savedKey = localStorage.getItem(`${provider}ApiKey`);
            if (savedKey) {
                input.value = savedKey;
            }
        }

        // 工具函数
        function formatSignificantDigits(num, minDigits = 4) {
            if (num === 0) return '0';
            const absNum = Math.abs(num);
            if (absNum >= 1) {
                const integerDigits = Math.floor(Math.log10(absNum)) + 1;
                const decimalPlaces = Math.max(0, minDigits - integerDigits);
                return num.toFixed(decimalPlaces);
            }
            const magnitude = Math.floor(Math.log10(absNum));
            const decimalPlaces = minDigits - magnitude - 1;
            return num.toFixed(Math.max(0, decimalPlaces));
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function switchChartTimeframe(timeframe) {
            currentTimeframe = timeframe;
            document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            if (currentChartData) {
                if (timeframe === '1H') {
                    drawChart(currentChartData.timestamps1H, currentChartData.closes1H, 
                             currentChartData.ema20_1H, currentChartData.ema50_1H);
                } else {
                    drawChart(currentChartData.timestamps4H, currentChartData.closes4H, 
                             currentChartData.ema20_4H, currentChartData.ema50_4H);
                }
            }
        }

        function togglePositionDetails() {
            const status = document.getElementById('positionStatus').value;
            const details = document.getElementById('positionDetails');
            details.style.display = (status !== 'none') ? 'block' : 'none';
        }

        function resetForm() {
            stopMonitoring();
            document.getElementById('results').classList.remove('active');
            document.getElementById('positionStatus').value = 'none';
            togglePositionDetails();
        }

        function initCoinSelector() {
            const selector = document.getElementById('coinSelector');
            popularCoins.forEach(coin => {
                const chip = document.createElement('div');
                chip.className = 'coin-chip';
                chip.textContent = coin;
                chip.onclick = function() {
                    this.classList.toggle('selected');
                };
                selector.appendChild(chip);
            });
            selector.querySelectorAll('.coin-chip').forEach((chip, i) => {
                if (i < 5) chip.classList.add('selected');
            });
        }

        // 自动刷新功能
        async function startMonitoring() {
            const symbol = document.getElementById('symbol').value.toUpperCase().trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!symbol) {
                alert('请输入币种代码');
                return;
            }

            if (!apiKey) {
                alert('请输入API Key');
                return;
            }

            document.getElementById('startBtn').disabled = true;
            document.getElementById('loading').classList.add('active');

            try {
                await updateMarketData();
                
                isMonitoring = true;
                document.getElementById('results').classList.add('active');
                document.getElementById('refreshControl').style.display = 'block';
                document.getElementById('aiBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('autoRefreshToggle').checked = true;
                
                toggleAutoRefresh();
                
            } catch (error) {
                console.error('启动失败:', error);
                alert('启动失败: ' + error.message);
                document.getElementById('startBtn').disabled = false;
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        function stopMonitoring() {
            isMonitoring = false;
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
            if (nextUpdateTimeout) {
                clearInterval(nextUpdateTimeout);
                nextUpdateTimeout = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('aiBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('autoRefreshToggle').checked = false;
            document.getElementById('refreshControl').style.display = 'none';
            document.getElementById('autoRefreshBadge').classList.remove('active');
            document.getElementById('refreshStatus').textContent = '自动更新已停止';
            document.getElementById('nextUpdateTime').textContent = '下次更新: --';
        }

        function toggleAutoRefresh() {
            const isEnabled = document.getElementById('autoRefreshToggle').checked;
            
            if (isEnabled && isMonitoring) {
                startAutoRefresh();
            } else {
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                    autoRefreshTimer = null;
                }
                if (nextUpdateTimeout) {
                    clearInterval(nextUpdateTimeout);
                    nextUpdateTimeout = null;
                }
                document.getElementById('autoRefreshBadge').classList.remove('active');
                document.getElementById('refreshStatus').textContent = '自动更新已暂停';
                document.getElementById('nextUpdateTime').textContent = '下次更新: --';
            }
        }

        function startAutoRefresh() {
            const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
            
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            autoRefreshTimer = setInterval(() => {
                updateMarketData();
            }, interval);
            
            document.getElementById('autoRefreshBadge').classList.add('active');
            document.getElementById('refreshStatus').textContent = '自动更新运行中';
            
            updateNextUpdateTime();
        }

        function updateRefreshInterval() {
            if (document.getElementById('autoRefreshToggle').checked) {
                startAutoRefresh();
            }
        }

        function updateNextUpdateTime() {
            if (nextUpdateTimeout) {
                clearInterval(nextUpdateTimeout);
            }
            
            const interval = parseInt(document.getElementById('refreshInterval').value);
            const nextTime = new Date(Date.now() + interval * 1000);
            
            const updateDisplay = () => {
                const now = new Date();
                const diff = Math.max(0, Math.floor((nextTime - now) / 1000));
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                document.getElementById('nextUpdateTime').textContent = 
                    `下次更新: ${minutes}分${seconds}秒`;
            };
            
            updateDisplay();
            nextUpdateTimeout = setInterval(updateDisplay, 1000);
        }

        async function updateMarketData() {
            const symbol = document.getElementById('symbol').value.toUpperCase().trim();
            const tradeType = document.getElementById('tradeType').value;
            const instId = tradeType === 'SPOT' ? `${symbol}-USDT` : `${symbol}-USDT-SWAP`;

            try {
                document.querySelectorAll('.data-item').forEach(item => {
                    item.classList.add('updating');
                });

                const [data1H, data4H] = await Promise.all([
                    fetchMarketData(instId, tradeType, '1H', 100),
                    fetchMarketData(instId, tradeType, '4H', 100)
                ]);

                lastMarketData = { data1H, data4H, symbol, tradeType };

                currentChartData = {
                    timestamps1H: data1H.timestamps,
                    closes1H: data1H.closes,
                    ema20_1H: data1H.ema20,
                    ema50_1H: data1H.ema50,
                    timestamps4H: data4H.timestamps,
                    closes4H: data4H.closes,
                    ema20_4H: data4H.ema20,
                    ema50_4H: data4H.ema50
                };

                displayMarketData({
                    symbol: symbol,
                    currentPrice: data1H.currentPrice,
                    change24h: data1H.change24h,
                    high24h: data1H.high24h,
                    low24h: data1H.low24h,
                    volume24h: data1H.volume24h,
                    fundingRate: data1H.fundingRate,
                    openInterest: data1H.openInterest
                });

                displayIndicators(data1H.indicators, '1H');
                displayIndicators(data4H.indicators, '4H');

                if (currentTimeframe === '1H') {
                    drawChart(data1H.timestamps, data1H.closes, data1H.ema20, data1H.ema50);
                } else {
                    drawChart(data4H.timestamps, data4H.closes, data4H.ema20, data4H.ema50);
                }

                document.getElementById('lastUpdate').textContent = 
                    `最后更新: ${new Date().toLocaleTimeString('zh-CN')}`;

                setTimeout(() => {
                    document.querySelectorAll('.data-item').forEach(item => {
                        item.classList.remove('updating');
                    });
                }, 300);

                if (document.getElementById('autoRefreshToggle').checked) {
                    updateNextUpdateTime();
                }

            } catch (error) {
                console.error('更新市场数据失败:', error);
            }
        }

        async function triggerAIAnalysis() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                alert('请输入API Key');
                return;
            }

            if (!lastMarketData) {
                alert('请先获取市场数据');
                return;
            }

            document.getElementById('aiBtn').disabled = true;
            document.getElementById('loading').classList.add('active');

            try {
                await updateMarketData();

                const { data1H, data4H, symbol } = lastMarketData;
                const positionStatus = document.getElementById('positionStatus').value;

                let positionInfo = {
                    status: positionStatus,
                    entryPrice: null,
                    size: null,
                    leverage: null,
                    pnl: null,
                    pnlPercent: null
                };

                if (positionStatus !== 'none') {
                    positionInfo.entryPrice = parseFloat(document.getElementById('entryPrice').value);
                    positionInfo.size = parseFloat(document.getElementById('positionSize').value);
                    positionInfo.leverage = parseFloat(document.getElementById('leverage').value);
                    
                    if (positionStatus === 'long') {
                        positionInfo.pnl = (data1H.currentPrice - positionInfo.entryPrice) * positionInfo.size;
                        positionInfo.pnlPercent = ((data1H.currentPrice - positionInfo.entryPrice) / positionInfo.entryPrice * 100);
                    } else {
                        positionInfo.pnl = (positionInfo.entryPrice - data1H.currentPrice) * positionInfo.size;
                        positionInfo.pnlPercent = ((positionInfo.entryPrice - data1H.currentPrice) / positionInfo.entryPrice * 100);
                    }
                }

                const aiAdvice = await getAIAdvice({
                    symbol: symbol,
                    tradeType: lastMarketData.tradeType,
                    currentPrice: data1H.currentPrice,
                    marketData: {
                        change24h: data1H.change24h,
                        high24h: data1H.high24h,
                        low24h: data1H.low24h,
                        volume24h: data1H.volume24h,
                        fundingRate: data1H.fundingRate,
                        openInterest: data1H.openInterest
                    },
                    indicators1H: data1H.indicators,
                    indicators4H: data4H.indicators,
                    position: positionInfo,
                    recentPrices1H: data1H.closes.slice(-20),
                    recentPrices4H: data4H.closes.slice(-10)
                }, apiKey, currentAIProvider);

                displayAIAdvice(aiAdvice);
                document.getElementById('aiAdviceSection').style.display = 'block';
                document.getElementById('aiUpdateTime').textContent = 
                    `分析时间: ${new Date().toLocaleTimeString('zh-CN')}`;

            } catch (error) {
                console.error('AI分析失败:', error);
                alert('AI分析失败: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('aiBtn').disabled = false;
            }
        }

        // 技术指标计算
        function calculateEMA(data, period) {
            const k = 2 / (period + 1);
            let ema = [data[0]];
            for (let i = 1; i < data.length; i++) {
                ema.push(data[i] * k + ema[i - 1] * (1 - k));
            }
            return ema;
        }

        function calculateRSI(data, period) {
            let gains = [];
            let losses = [];
            
            for (let i = 1; i < data.length; i++) {
                const difference = data[i] - data[i - 1];
                gains.push(difference > 0 ? difference : 0);
                losses.push(difference < 0 ? -difference : 0);
            }
            
            if (gains.length < period) return [50];
            
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b) / period;
            
            if (avgLoss === 0) return [100];
            
            let rsi = [100 - (100 / (1 + avgGain / avgLoss))];
            
            for (let i = period; i < gains.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                rsi.push(avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss)));
            }
            
            return rsi;
        }

        function calculateMACD(data) {
            const ema12 = calculateEMA(data, 12);
            const ema26 = calculateEMA(data, 26);
            const macdLine = ema12.map((val, i) => val - ema26[i]);
            const signalLine = calculateEMA(macdLine, 9);
            const histogram = macdLine.map((val, i) => val - signalLine[i]);
            
            return {
                macd: macdLine[macdLine.length - 1],
                signal: signalLine[signalLine.length - 1],
                histogram: histogram[histogram.length - 1]
            };
        }

        function calculateATR(high, low, close, period) {
            let tr = [];
            for (let i = 1; i < high.length; i++) {
                const hl = high[i] - low[i];
                const hc = Math.abs(high[i] - close[i - 1]);
                const lc = Math.abs(low[i] - close[i - 1]);
                tr.push(Math.max(hl, hc, lc));
            }
            
            if (tr.length < period) return 0;
            
            let atr = tr.slice(0, period).reduce((a, b) => a + b) / period;
            for (let i = period; i < tr.length; i++) {
                atr = (atr * (period - 1) + tr[i]) / period;
            }
            
            return atr;
        }

        function calculateTechnicalScore(indicators, currentPrice) {
            let score = 50;
            
            if (currentPrice > indicators.ema20 && indicators.ema20 > indicators.ema50) {
                score += 15;
            } else if (currentPrice < indicators.ema20 && indicators.ema20 < indicators.ema50) {
                score -= 15;
            }
            
            if (indicators.rsi14 < 30) {
                score += 15;
            } else if (indicators.rsi14 > 70) {
                score -= 15;
            } else if (indicators.rsi14 >= 40 && indicators.rsi14 <= 60) {
                score += 5;
            }
            
            if (indicators.macd.histogram > 0 && indicators.macd.macd > indicators.macd.signal) {
                score += 10;
            } else if (indicators.macd.histogram < 0 && indicators.macd.macd < indicators.macd.signal) {
                score -= 10;
            }
            
            return Math.max(0, Math.min(100, score));
        }

        function getSignalFromScore(score) {
            if (score >= 70) return { text: '强烈做多', class: 'signal-buy' };
            if (score >= 55) return { text: '建议做多', class: 'signal-buy' };
            if (score >= 45) return { text: '观望', class: 'signal-wait' };
            if (score >= 30) return { text: '建议做空', class: 'signal-sell' };
            return { text: '强烈做空', class: 'signal-sell' };
        }

        // 数据获取
        async function fetchMarketData(instId, tradeType, bar, limit) {
            const candlesResponse = await axios.get(`https://www.okx.com/api/v5/market/candles`, {
                params: { instId, bar, limit }
            });

            const candles = candlesResponse.data.data;
            if (!candles || candles.length === 0) {
                throw new Error('无法获取K线数据');
            }

            candles.reverse();
            const timestamps = candles.map(c => new Date(parseInt(c[0])));
            const opens = candles.map(c => parseFloat(c[1]));
            const highs = candles.map(c => parseFloat(c[2]));
            const lows = candles.map(c => parseFloat(c[3]));
            const closes = candles.map(c => parseFloat(c[4]));
            const volumes = candles.map(c => parseFloat(c[5]));

            const tickerResponse = await axios.get(`https://www.okx.com/api/v5/market/ticker`, {
                params: { instId }
            });
            const ticker = tickerResponse.data.data[0];
            const currentPrice = parseFloat(ticker.last);
            const open24h = parseFloat(ticker.sodUtc0);
            const change24h = open24h > 0 ? ((currentPrice - open24h) / open24h * 100) : 0;

            let fundingRate = 'N/A';
            if (tradeType !== 'SPOT') {
                try {
                    const fundingResponse = await axios.get(`https://www.okx.com/api/v5/public/funding-rate`, {
                        params: { instId }
                    });
                    fundingRate = (parseFloat(fundingResponse.data.data[0].fundingRate) * 100).toFixed(4) + '%';
                } catch (e) {}
            }

            let openInterest = 'N/A';
            if (tradeType !== 'SPOT') {
                try {
                    const oiResponse = await axios.get(`https://www.okx.com/api/v5/public/open-interest`, {
                        params: { instId }
                    });
                    openInterest = parseFloat(oiResponse.data.data[0].oi).toLocaleString();
                } catch (e) {}
            }

            const ema20 = calculateEMA(closes, 20);
            const ema50 = calculateEMA(closes, 50);
            const rsi7 = calculateRSI(closes, 7);
            const rsi14 = calculateRSI(closes, 14);
            const macd = calculateMACD(closes);
            const atr = calculateATR(highs, lows, closes, 14);

            return {
                timestamps, opens, highs, lows, closes, volumes,
                currentPrice, change24h,
                high24h: parseFloat(ticker.high24h),
                low24h: parseFloat(ticker.low24h),
                volume24h: parseFloat(ticker.vol24h),
                fundingRate, openInterest,
                ema20, ema50,
                indicators: {
                    ema20: ema20[ema20.length - 1],
                    ema50: ema50[ema50.length - 1],
                    rsi7: rsi7[rsi7.length - 1],
                    rsi14: rsi14[rsi14.length - 1],
                    macd: macd,
                    atr: atr
                }
            };
        }

        // 数据显示
        function displayMarketData(data) {
            const container = document.getElementById('marketData');
            const changeClass = data.change24h >= 0 ? 'positive' : 'negative';
            const changeSymbol = data.change24h >= 0 ? '📈' : '📉';
            
            container.innerHTML = `
                <div class="data-item">
                    <div class="data-label">当前价格</div>
                    <div class="data-value">${formatSignificantDigits(data.currentPrice, 4)} USDT</div>
                </div>
                <div class="data-item">
                    <div class="data-label">24小时涨跌 ${changeSymbol}</div>
                    <div class="data-value ${changeClass}">${data.change24h.toFixed(2)}%</div>
                </div>
                <div class="data-item">
                    <div class="data-label">24小时最高</div>
                    <div class="data-value">${formatSignificantDigits(data.high24h, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">24小时最低</div>
                    <div class="data-value">${formatSignificantDigits(data.low24h, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">24小时成交量</div>
                    <div class="data-value">${data.volume24h.toFixed(2)} ${data.symbol}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">资金费率</div>
                    <div class="data-value">${data.fundingRate}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">持仓量</div>
                    <div class="data-value">${data.openInterest}</div>
                </div>
            `;
        }

        function displayIndicators(data, timeframe) {
            const container = document.getElementById('indicators' + timeframe);
            const rsi7Class = data.rsi7 > 70 ? 'negative' : data.rsi7 < 30 ? 'positive' : '';
            const rsi14Class = data.rsi14 > 70 ? 'negative' : data.rsi14 < 30 ? 'positive' : '';
            
            container.innerHTML = `
                <div class="data-item">
                    <div class="data-label">EMA(20)</div>
                    <div class="data-value">${formatSignificantDigits(data.ema20, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">EMA(50)</div>
                    <div class="data-value">${formatSignificantDigits(data.ema50, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">RSI(7)</div>
                    <div class="data-value ${rsi7Class}">${data.rsi7.toFixed(2)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">RSI(14)</div>
                    <div class="data-value ${rsi14Class}">${data.rsi14.toFixed(2)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">MACD</div>
                    <div class="data-value">${formatSignificantDigits(data.macd.macd, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">MACD信号线</div>
                    <div class="data-value">${formatSignificantDigits(data.macd.signal, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">MACD柱状图</div>
                    <div class="data-value ${data.macd.histogram > 0 ? 'positive' : 'negative'}">${formatSignificantDigits(data.macd.histogram, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">ATR(14)</div>
                    <div class="data-value">${formatSignificantDigits(data.atr, 4)}</div>
                </div>
            `;
        }

        function drawChart(timestamps, closes, ema20, ema50) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps.map(t => t.toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit' })),
                    datasets: [
                        {
                            label: '价格',
                            data: closes,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'EMA(20)',
                            data: ema20,
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'EMA(50)',
                            data: ema50,
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: '价格走势与均线' }
                    },
                    scales: { y: { beginAtZero: false } }
                }
            });
        }

        // AI分析（改进版）
        async function getAIAdvice(data, apiKey, provider) {
            const atr1H = data.indicators1H.atr;
            const atr4H = data.indicators4H.atr;
            
            // 计算关键价格位
            const currentPrice = data.currentPrice;
            const high24h = data.marketData.high24h;
            const low24h = data.marketData.low24h;
            const ema20_1H = data.indicators1H.ema20;
            const ema50_1H = data.indicators1H.ema50;
            const ema20_4H = data.indicators4H.ema20;
            const ema50_4H = data.indicators4H.ema50;
            
            let prompt = `你是一名经验丰富的激进的专业交易员，正在用自己的资金交易${data.symbol}。现在需要你做出真实的交易决策，语言简练，不要说客套话

=== 市场数据 ===
当前价格: ${formatSignificantDigits(currentPrice, 4)} USDT
24H变化: ${data.marketData.change24h.toFixed(2)}%
24H高点: ${formatSignificantDigits(high24h, 4)} | 低点: ${formatSignificantDigits(low24h, 4)}
ATR(1H): ${formatSignificantDigits(atr1H, 4)} | ATR(4H): ${formatSignificantDigits(atr4H, 4)}

=== 技术指标 ===
【1小时级别】
- EMA20: ${formatSignificantDigits(ema20_1H, 4)} | EMA50: ${formatSignificantDigits(ema50_1H, 4)}
- RSI: ${data.indicators1H.rsi14.toFixed(2)} | MACD柱: ${formatSignificantDigits(data.indicators1H.macd.histogram, 4)}

【4小时级别】
- EMA20: ${formatSignificantDigits(ema20_4H, 4)} | EMA50: ${formatSignificantDigits(ema50_4H, 4)}
- RSI: ${data.indicators4H.rsi14.toFixed(2)} | MACD柱: ${formatSignificantDigits(data.indicators4H.macd.histogram, 4)}

=== 近期价格行为 ===
最近20根1H K线收盘价: ${data.recentPrices1H.slice(-5).map(p => formatSignificantDigits(p, 4)).join(', ')}...
最近10根4H K线收盘价: ${data.recentPrices4H.slice(-3).map(p => formatSignificantDigits(p, 4)).join(', ')}...
`;

            if (data.position.status !== 'none') {
                const posType = data.position.status === 'long' ? '多头' : '空头';
                const pnl = data.position.pnlPercent.toFixed(2);
                const entryPrice = data.position.entryPrice;
                
                prompt += `
=== 当前持仓 ===
方向: ${posType}
开仓价: ${formatSignificantDigits(entryPrice, 4)} USDT
持仓: ${data.position.size} ${data.symbol}
杠杆: ${data.position.leverage}x
浮动盈亏: ${pnl}%

作为交易员，你现在必须做出决策：

【分析步骤】
1. 趋势判断：1H和4H的EMA排列是否一致？当前处于什么趋势阶段？
2. 动能分析：MACD和RSI显示动能是增强还是衰减？
3. 关键价位：
   - 向上压力位：24H高点${formatSignificantDigits(high24h, 4)}、4H EMA20/50
   - 向下支撑位：24H低点${formatSignificantDigits(low24h, 4)}、1H EMA20/50
4. 盈亏情况：当前${pnl}%的浮盈/浮亏是否应该兑现或止损？

【决策】（必须明确选一个）
□ 继续持有
□ 部分止盈
□ 全部止盈
□ 止损离场
□ 加仓

【执行计划】
三级止盈方案（结合关键压力位和ATR）：
- 第一目标（30%仓位）: [价格] - 理由：[关键位置/ATR倍数]
- 第二目标（40%仓位）: [价格] - 理由：[关键位置/ATR倍数]  
- 第三目标（30%仓位）: [价格] - 理由：[关键位置/ATR倍数]

止损位：[价格] - 必须说明是基于什么（关键支撑位/1.5-2倍ATR/保护利润）

【核心逻辑】（1-2句话）
为什么做这个决策？多空共振？趋势延续？还是背离信号？
`;
            } else {
                prompt += `
=== 当前状态 ===
未持仓，正在寻找入场机会。

作为交易员，你必须评估当前价格是否应该入场：

【分析步骤】
1. 多空判断：
   - 1H级别：价格vs EMA20 vs EMA50的位置关系
   - 4H级别：价格vs EMA20 vs EMA50的位置关系
   - 双周期是否共振？

2. 动能确认：
   - RSI是否超买/超卖/中性？
   - MACD柱是否放大/收缩？
   - 价格动能是否与指标背离？

3. 关键价位识别：
   - 压力位：24H高点${formatSignificantDigits(high24h, 4)}、EMA均线
   - 支撑位：24H低点${formatSignificantDigits(low24h, 4)}、EMA均线
   - 当前价格离哪个关键位更近？

4. 风险收益比：
   - 入场到第一目标的空间是否足够？
   - 止损距离是否合理（不超过2倍ATR）？

【决策】（必须明确选一个）
□ 做多
□ 做空
□ 观望等待

如果【做多】或【做空】，提供：

入场策略：
- 当前价格的入场区间：[价格1] - [价格2]（基于回调/突破+ATR）

三级止盈（结合关键压力位/支撑位和ATR）：
- 保守目标（30%）: [价格] - [压力位/支撑位 + ATR倍数]
- 中性目标（40%）: [价格] - [下一个关键位 + ATR倍数]
- 激进目标（30%）: [价格] - [重要心理关口 + ATR倍数]

止损位：[价格] - 基于[关键支撑/压力位]或[1.5-2倍ATR]

如果【观望】，说明：
- 等待什么信号？（突破、回调、指标修复）
- 关注哪个价位？（突破做多 / 跌破做空）
- 具体触发条件

【核心逻辑】（2-3句话）
为什么做多/做空/观望？多空趋势如何？关键位在哪？1H和4H是否共振？
`;
            }

            prompt += `
【回复要求】
1. 像一个激进的专业交易员一样思考和决策
2. 价格必须具体且合理，基于当前价格进行决策：
   - 止盈位要考虑关键压力位/支撑位，不能只看ATR
   - 止损位要保护本金或利润，设在关键位附近
3. 三级止盈间隔要够大（3-5倍ATR或关键位之间的距离）
4. 说明每个价位的依据（是EMA？是24H高低点？还是ATR倍数？）
5. 不要客套话，直接给决策和理由
6. 要体现对市场结构的理解（趋势、支撑压力、动能）`;

            try {
                let apiUrl, modelName, headers;
                
                if (provider === 'deepseek') {
                    apiUrl = 'https://api.deepseek.com/v1/chat/completions';
                    modelName = 'deepseek-chat';
                    headers = {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    };
                } else {
                    apiUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
                    modelName = 'qwen-plus';
                    headers = {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    };
                }

                const response = await axios.post(apiUrl, {
                    model: modelName,
                    messages: [
                        {
                            role: 'system',
                            content: '你是一名顶尖的加密货币交易员，拥有10年实战经验。你擅长多时间框架分析、识别关键价格位、判断市场结构。你用自己的资金交易，每个决策都是真金白银。你的风格：果断、精准、激进，从不模棱两可。'
                        },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                }, { headers });

                return response.data.choices[0].message.content;
            } catch (error) {
                console.error('AI API调用失败:', error);
                throw new Error('AI分析失败: ' + (error.response?.data?.error?.message || error.message));
            }
        }

        function displayAIAdvice(advice) {
            const container = document.getElementById('aiAdvice');
            
            let signal = '';
            const lowerAdvice = advice.toLowerCase();
            
            if (lowerAdvice.includes('做多') || lowerAdvice.includes('买入')) {
                signal = '<span class="signal-badge signal-buy">📈 做多</span>';
            } else if (lowerAdvice.includes('做空') || lowerAdvice.includes('卖出')) {
                signal = '<span class="signal-badge signal-sell">📉 做空</span>';
            } else if (lowerAdvice.includes('继续持有') || lowerAdvice.includes('持有')) {
                signal = '<span class="signal-badge signal-hold">⏸️ 持有</span>';
            } else if (lowerAdvice.includes('止盈')) {
                signal = '<span class="signal-badge signal-buy">💰 止盈</span>';
            } else if (lowerAdvice.includes('止损')) {
                signal = '<span class="signal-badge signal-sell">🛑 止损</span>';
            } else if (lowerAdvice.includes('观望')) {
                signal = '<span class="signal-badge signal-wait">👀 观望</span>';
            }
            
            container.innerHTML = signal + '<br><br>' + advice.replace(/\n/g, '<br>');
        }

        // 多币种雷达
        async function startRadarScan() {
            const selectedCoins = Array.from(document.querySelectorAll('.coin-chip.selected')).map(chip => chip.textContent);
            
            if (selectedCoins.length === 0) {
                alert('请至少选择一个币种');
                return;
            }

            const tradeType = document.getElementById('multiTradeType').value;

            document.getElementById('radarLoading').classList.add('active');
            document.getElementById('radarResults').classList.remove('active');

            const results = [];
            let completed = 0;

            for (const coin of selectedCoins) {
                try {
                    const instId = tradeType === 'SPOT' ? `${coin}-USDT` : `${coin}-USDT-SWAP`;
                    const data = await fetchMarketData(instId, tradeType, '1H', 100);
                    
                    const score = calculateTechnicalScore(data.indicators, data.currentPrice);
                    const signal = getSignalFromScore(score);
                    
                    results.push({
                        coin, score, signal,
                        currentPrice: data.currentPrice,
                        change24h: data.change24h,
                        indicators: data.indicators
                    });

                    completed++;
                    document.getElementById('scanProgress').textContent = `${completed}/${selectedCoins.length}`;
                } catch (error) {
                    console.error(`扫描${coin}失败:`, error);
                }
            }

            results.sort((a, b) => b.score - a.score);
            displayRadarResults(results);

            document.getElementById('radarLoading').classList.remove('active');
            document.getElementById('radarResults').classList.add('active');
        }

        function displayRadarResults(results) {
            const container = document.getElementById('comparisonGrid');
            
            container.innerHTML = results.map(result => {
                const scoreColor = result.score >= 70 ? '#28a745' : 
                                   result.score >= 55 ? '#17a2b8' : 
                                   result.score >= 45 ? '#ffc107' : 
                                   result.score >= 30 ? '#fd7e14' : '#dc3545';
                
                return `
                    <div class="coin-card">
                        <div class="coin-card-header">
                            <div class="coin-name">${result.coin}</div>
                            <div class="coin-signal ${result.signal.class}">${result.signal.text}</div>
                        </div>
                        
                        <div class="score-container">
                            <div class="score-circle" style="background: linear-gradient(135deg, ${scoreColor}, ${scoreColor}88); color: white;">
                                ${result.score}
                            </div>
                            <div class="score-label">技术评分</div>
                        </div>
                        
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">当前价格</div>
                                <div class="data-value">${formatSignificantDigits(result.currentPrice, 4)}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">24h涨跌</div>
                                <div class="data-value ${result.change24h >= 0 ? 'positive' : 'negative'}">
                                    ${result.change24h.toFixed(2)}%
                                </div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">RSI(14)</div>
                                <div class="data-value">${result.indicators.rsi14.toFixed(2)}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">MACD</div>
                                <div class="data-value ${result.indicators.macd.histogram > 0 ? 'positive' : 'negative'}">
                                    ${formatSignificantDigits(result.indicators.macd.histogram, 4)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 历史回测
        async function startBacktest() {
            const symbol = document.getElementById('backtestSymbol').value.toUpperCase().trim();
            const period = parseInt(document.getElementById('backtestPeriod').value);
            const capital = parseFloat(document.getElementById('backtestCapital').value);
            const positionSize = parseFloat(document.getElementById('backtestPosition').value);

            if (!symbol) {
                alert('请输入币种代码');
                return;
            }

            document.getElementById('backtestLoading').classList.add('active');
            document.getElementById('backtestResults').classList.remove('active');

            try {
                const instId = `${symbol}-USDT-SWAP`;
                const response = await axios.get(`https://www.okx.com/api/v5/market/history-candles`, {
                    params: {
                        instId: instId,
                        bar: '4H',
                        limit: Math.min(period * 6, 100)
                    }
                });

                const candles = response.data.data;
                if (!candles || candles.length === 0) {
                    throw new Error('无法获取历史数据');
                }

                candles.reverse();
                const closes = candles.map(c => parseFloat(c[4]));
                const timestamps = candles.map(c => new Date(parseInt(c[0])));
                const ema20 = calculateEMA(closes, 20);
                const ema50 = calculateEMA(closes, 50);
                const backtestResult = runBacktest(closes, ema20, ema50, capital, positionSize, timestamps);

                displayBacktestResults(backtestResult);

                document.getElementById('backtestLoading').classList.remove('active');
                document.getElementById('backtestResults').classList.add('active');

            } catch (error) {
                console.error('回测失败:', error);
                alert('回测失败: ' + error.message);
                document.getElementById('backtestLoading').classList.remove('active');
            }
        }

        function runBacktest(closes, ema20, ema50, initialCapital, positionSize, timestamps) {
            let capital = initialCapital;
            let position = null;
            let trades = [];
            let equityCurve = [initialCapital];
            let winCount = 0;
            let lossCount = 0;
            let totalProfit = 0;
            let totalLoss = 0;

            for (let i = 50; i < closes.length; i++) {
                const currentPrice = closes[i];
                const prevEma20 = ema20[i - 1];
                const prevEma50 = ema50[i - 1];
                const currEma20 = ema20[i];
                const currEma50 = ema50[i];

                if (!position) {
                    if (prevEma20 <= prevEma50 && currEma20 > currEma50) {
                        const amount = capital * positionSize;
                        const quantity = amount / currentPrice;
                        position = {
                            type: 'long',
                            entryPrice: currentPrice,
                            quantity: quantity,
                            entryTime: timestamps[i]
                        };
                    } else if (prevEma20 >= prevEma50 && currEma20 < currEma50) {
                        const amount = capital * positionSize;
                        const quantity = amount / currentPrice;
                        position = {
                            type: 'short',
                            entryPrice: currentPrice,
                            quantity: quantity,
                            entryTime: timestamps[i]
                        };
                    }
                } else {
                    let shouldClose = false;
                    
                    if (position.type === 'long' && prevEma20 >= prevEma50 && currEma20 < currEma50) {
                        shouldClose = true;
                    } else if (position.type === 'short' && prevEma20 <= prevEma50 && currEma20 > currEma50) {
                        shouldClose = true;
                    }

                    if (shouldClose) {
                        let pnl = 0;
                        if (position.type === 'long') {
                            pnl = (currentPrice - position.entryPrice) * position.quantity;
                        } else {
                            pnl = (position.entryPrice - currentPrice) * position.quantity;
                        }

                        const pnlPercent = (pnl / (position.entryPrice * position.quantity)) * 100;
                        capital += pnl;

                        if (pnl > 0) {
                            winCount++;
                            totalProfit += pnl;
                        } else {
                            lossCount++;
                            totalLoss += Math.abs(pnl);
                        }

                        trades.push({
                            type: position.type,
                            entryPrice: position.entryPrice,
                            exitPrice: currentPrice,
                            entryTime: position.entryTime,
                            exitTime: timestamps[i],
                            pnl: pnl,
                            pnlPercent: pnlPercent
                        });

                        position = null;
                    }
                }

                let currentEquity = capital;
                if (position) {
                    if (position.type === 'long') {
                        currentEquity += (currentPrice - position.entryPrice) * position.quantity;
                    } else {
                        currentEquity += (position.entryPrice - currentPrice) * position.quantity;
                    }
                }
                equityCurve.push(currentEquity);
            }

            const totalTrades = trades.length;
            const winRate = totalTrades > 0 ? (winCount / totalTrades * 100) : 0;
            const avgProfit = winCount > 0 ? totalProfit / winCount : 0;
            const avgLoss = lossCount > 0 ? totalLoss / lossCount : 0;
            const profitFactor = totalLoss > 0 ? totalProfit / totalLoss : 0;
            const finalReturn = ((capital - initialCapital) / initialCapital * 100);

            return {
                initialCapital, finalCapital: capital, totalReturn: finalReturn,
                totalTrades, winCount, lossCount, winRate,
                avgProfit, avgLoss, profitFactor,
                trades, equityCurve, timestamps
            };
        }

        function displayBacktestResults(result) {
            const summary = document.getElementById('backtestSummary');
            summary.innerHTML = `
                <div class="backtest-metric">
                    <div class="backtest-metric-label">初始资金</div>
                    <div class="backtest-metric-value">$${result.initialCapital.toLocaleString()}</div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">最终资金</div>
                    <div class="backtest-metric-value" style="color: ${result.finalCapital >= result.initialCapital ? '#28a745' : '#dc3545'}">
                        $${result.finalCapital.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">总收益率</div>
                    <div class="backtest-metric-value" style="color: ${result.totalReturn >= 0 ? '#28a745' : '#dc3545'}">
                        ${result.totalReturn.toFixed(2)}%
                    </div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">交易次数</div>
                    <div class="backtest-metric-value">${result.totalTrades}</div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">胜率</div>
                    <div class="backtest-metric-value" style="color: ${result.winRate >= 50 ? '#28a745' : '#dc3545'}">
                        ${result.winRate.toFixed(1)}%
                    </div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">盈利因子</div>
                    <div class="backtest-metric-value" style="color: ${result.profitFactor >= 1 ? '#28a745' : '#dc3545'}">
                        ${result.profitFactor.toFixed(2)}
                    </div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">平均盈利</div>
                    <div class="backtest-metric-value positive">$${result.avgProfit.toFixed(2)}</div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">平均亏损</div>
                    <div class="backtest-metric-value negative">$${result.avgLoss.toFixed(2)}</div>
                </div>
            `;

            drawEquityCurve(result.equityCurve, result.timestamps);

            const tradeList = document.getElementById('tradeList');
            tradeList.innerHTML = result.trades.map((trade, index) => `
                <div class="trade-item ${trade.pnl > 0 ? 'profit' : 'loss'}">
                    <div>
                        <strong>#${index + 1}</strong> 
                        ${trade.type === 'long' ? '📈 做多' : '📉 做空'}
                        <br>
                        <small>${trade.entryTime.toLocaleString('zh-CN', {month: 'short', day: 'numeric', hour: '2-digit'})}</small>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.2em; font-weight: 700; color: ${trade.pnl > 0 ? '#28a745' : '#dc3545'}">
                            ${trade.pnl > 0 ? '+' : ''}$${trade.pnl.toFixed(2)}
                        </div>
                        <small>${trade.pnlPercent > 0 ? '+' : ''}${trade.pnlPercent.toFixed(2)}%</small>
                    </div>
                </div>
            `).join('');
        }

        function drawEquityCurve(equityCurve, timestamps) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            if (equityChart) {
                equityChart.destroy();
            }

            const labels = [];
            for (let i = 0; i < equityCurve.length; i++) {
                if (i < timestamps.length) {
                    labels.push(timestamps[i].toLocaleString('zh-CN', {month: 'short', day: 'numeric'}));
                } else {
                    labels.push('');
                }
            }

            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '账户权益',
                        data: equityCurve,
                        borderColor: equityCurve[equityCurve.length - 1] >= equityCurve[0] ? 'rgb(40, 167, 69)' : 'rgb(220, 53, 69)',
                        backgroundColor: equityCurve[equityCurve.length - 1] >= equityCurve[0] ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: '账户权益变化曲线' }
                    },
                    scales: { y: { beginAtZero: false } }
                }
            });
        }

        // 初始化
        window.onload = function() {
            const savedDeepseekKey = localStorage.getItem('deepseekApiKey');
            const savedQwenKey = localStorage.getItem('qwenApiKey');
            
            if (savedDeepseekKey && currentAIProvider === 'deepseek') {
                document.getElementById('apiKey').value = savedDeepseekKey;
            } else if (savedQwenKey && currentAIProvider === 'qwen') {
                document.getElementById('apiKey').value = savedQwenKey;
            }
            
            initCoinSelector();
        };

        document.getElementById('apiKey').addEventListener('change', function() {
            localStorage.setItem(`${currentAIProvider}ApiKey`, this.value);
        });

        document.querySelectorAll('input[name="aiProvider"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const provider = this.value;
                selectProvider(provider);
            });
        });

        window.addEventListener('beforeunload', () => {
            stopMonitoring();
        });
    </script>
</body>
</html>
