<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŠ å¯†è´§å¸äº¤æ˜“é¡¾é—® Pro v2.3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .auto-refresh-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .auto-refresh-badge.active {
            background: rgba(40, 167, 69, 0.3);
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .tab-container {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .last-update {
            font-size: 0.7em;
            color: #6c757d;
            font-weight: normal;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .position-details {
            display: none;
            animation: fadeIn 0.3s;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
            min-width: 200px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
            flex: 1;
            min-width: 200px;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .data-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .data-item.updating {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .data-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
        }

        .data-value.positive {
            color: #28a745;
        }

        .data-value.negative {
            color: #dc3545;
        }

        .ai-advice {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border: 3px solid #667eea;
        }

        .ai-advice-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .ai-icon {
            font-size: 2.5em;
        }

        .ai-advice-title {
            font-size: 1.8em;
            color: #667eea;
            font-weight: 700;
        }

        .advice-content {
            line-height: 1.8;
            font-size: 1.05em;
            color: #333;
            white-space: pre-wrap;
        }

        .signal-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1em;
            margin: 10px 0;
        }

        .signal-buy {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .signal-sell {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .signal-hold {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .signal-wait {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #17a2b8;
        }

        .chart-container {
            margin: 30px 0;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chart-tab {
            padding: 10px 20px;
            background: #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .chart-tab.active {
            background: #667eea;
            color: white;
        }

        .config-section {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .config-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 10px;
        }

        .coin-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .coin-chip {
            padding: 10px 20px;
            background: #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .coin-chip:hover {
            background: #dee2e6;
        }

        .coin-chip.selected {
            background: #667eea;
            color: white;
            border-color: #5568d3;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .coin-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .coin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .coin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .coin-name {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .coin-signal {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .score-container {
            text-align: center;
            margin: 20px 0;
        }

        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: 700;
            margin: 0 auto;
        }

        .score-label {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 10px;
        }

        .backtest-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .backtest-metric {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .backtest-metric-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .backtest-metric-value {
            font-size: 1.8em;
            font-weight: 700;
        }

        .trade-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .trade-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trade-item.profit {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .trade-item.loss {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        .refresh-control {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .refresh-control-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .refresh-settings {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .ai-provider-selector {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
        }

        .provider-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .provider-option:hover {
            background: #f8f9fa;
        }

        .provider-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .provider-label {
            font-weight: 600;
            font-size: 1.05em;
        }

        .provider-desc {
            font-size: 0.85em;
            color: #6c757d;
            margin-left: 30px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .tab {
                font-size: 0.9em;
                padding: 15px 10px;
            }

            .auto-refresh-badge {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIåŠ å¯†è´§å¸äº¤æ˜“é¡¾é—® Pro v2.3</h1>
            <p>åŒAIæ¨¡å‹ | å¤šçº§æ­¢ç›ˆæ­¢æŸ | ç²¾å‡†å»ºè®® | è‡ªåŠ¨æ›´æ–°</p>
            <div class="auto-refresh-badge" id="autoRefreshBadge">
                <div class="pulse"></div>
                <span id="refreshStatus">è‡ªåŠ¨æ›´æ–°å·²åœæ­¢</span>
            </div>
        </div>

        <div class="tab-container">
            <div class="tab active" onclick="switchTab('single')">
                ğŸ“Š å•å¸ç§åˆ†æ
            </div>
            <div class="tab" onclick="switchTab('multi')">
                ğŸ” å¤šå¸ç§é›·è¾¾
            </div>
            <div class="tab" onclick="switchTab('backtest')">
                ğŸ“ˆ å†å²å›æµ‹
            </div>
        </div>

        <!-- å•å¸ç§åˆ†æ -->
        <div id="tab-single" class="tab-content active">
            <div class="section">
                <div class="section-title">âš™ï¸ APIé…ç½®</div>
                <div class="config-section">
                    <div class="config-title">ğŸ“Œ ä½¿ç”¨è¯´æ˜</div>
                    <p>é€‰æ‹©AIæœåŠ¡å•†å¹¶è¾“å…¥API Keyã€‚æ”¯æŒDeepSeekå’Œé˜¿é‡Œäº‘åƒé—®ã€‚</p>
                </div>

                <!-- AIæœåŠ¡å•†é€‰æ‹© -->
                <div class="ai-provider-selector">
                    <div class="provider-option" onclick="selectProvider('deepseek')">
                        <input type="radio" name="aiProvider" id="providerDeepseek" value="deepseek" checked>
                        <label for="providerDeepseek" class="provider-label">ğŸ”µ DeepSeek</label>
                    </div>
                    <div class="provider-desc">æ¨ç†èƒ½åŠ›å¼ºï¼Œæˆæœ¬ä½ï¼ˆÂ¥0.001/åƒtokensï¼‰</div>
                    
                    <div class="provider-option" onclick="selectProvider('qwen')" style="margin-top: 10px;">
                        <input type="radio" name="aiProvider" id="providerQwen" value="qwen">
                        <label for="providerQwen" class="provider-label">ğŸŸ  é˜¿é‡Œäº‘åƒé—®</label>
                    </div>
                    <div class="provider-desc">ä¸­æ–‡ä¼˜åŒ–ï¼Œå“åº”å¿«ï¼ˆÂ¥0.002/åƒtokensï¼‰</div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            <span id="apiKeyLabel">DeepSeek API Key</span>
                        </label>
                        <input type="password" id="apiKey" placeholder="å¿…å¡«ï¼šsk-xxxxxx" required>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">ğŸ“Š äº¤æ˜“é…ç½®</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>å¸ç§ä»£ç </label>
                        <input type="text" id="symbol" placeholder="ä¾‹å¦‚: BTC" value="BTC" required>
                    </div>
                    <div class="form-group">
                        <label>äº¤æ˜“ç±»å‹</label>
                        <select id="tradeType">
                            <option value="SWAP">æ°¸ç»­åˆçº¦</option>
                            <option value="SPOT">ç°è´§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æŒä»“çŠ¶æ€</label>
                        <select id="positionStatus" onchange="togglePositionDetails()">
                            <option value="none">æœªæŒä»“</option>
                            <option value="long">å·²æŒä»“ - åšå¤š</option>
                            <option value="short">å·²æŒä»“ - åšç©º</option>
                        </select>
                    </div>
                </div>

                <div id="positionDetails" class="position-details">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>å¼€ä»“ä»·æ ¼ (USDT)</label>
                            <input type="number" id="entryPrice" placeholder="ä¾‹å¦‚: 42000" step="0.0001">
                        </div>
                        <div class="form-group">
                            <label>æŒä»“æ•°é‡</label>
                            <input type="number" id="positionSize" placeholder="ä¾‹å¦‚: 0.5" step="0.0001">
                        </div>
                        <div class="form-group">
                            <label>æ æ†å€æ•°</label>
                            <input type="number" id="leverage" placeholder="ä¾‹å¦‚: 10" value="10" min="1" max="125">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="startMonitoring()" id="startBtn">
                        ğŸš€ å¼€å§‹ç›‘æ§
                    </button>
                    <button class="btn btn-primary" onclick="triggerAIAnalysis()" id="aiBtn" disabled>
                        ğŸ¤– è·å–AIå»ºè®®
                    </button>
                    <button class="btn btn-warning" onclick="stopMonitoring()" id="stopBtn" disabled>
                        â¹ï¸ åœæ­¢ç›‘æ§
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()">
                        ğŸ”„ é‡ç½®
                    </button>
                </div>
            </div>

            <div class="refresh-control" id="refreshControl" style="display: none;">
                <div class="refresh-control-title">ğŸ”„ è‡ªåŠ¨æ›´æ–°è®¾ç½®</div>
                <div class="refresh-settings">
                    <div class="switch-container">
                        <label class="switch">
                            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
                            <span class="slider"></span>
                        </label>
                        <span>è‡ªåŠ¨æ›´æ–°å¸‚åœºæ•°æ®</span>
                    </div>
                    <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin: 0;">
                        <label style="margin: 0;">æ›´æ–°é—´éš”:</label>
                        <select id="refreshInterval" style="width: auto;" onchange="updateRefreshInterval()">
                            <option value="60">1åˆ†é’Ÿ</option>
                            <option value="180">3åˆ†é’Ÿ</option>
                            <option value="300" selected>5åˆ†é’Ÿ</option>
                            <option value="600">10åˆ†é’Ÿ</option>
                        </select>
                    </div>
                    <div style="color: #6c757d; font-size: 0.9em;">
                        <span id="nextUpdateTime">ä¸‹æ¬¡æ›´æ–°: --</span>
                    </div>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="color: #667eea; font-size: 1.2em; font-weight: 600;">æ­£åœ¨è·å–å¸‚åœºæ•°æ®...</p>
            </div>

            <div id="results" class="results">
                <div class="section">
                    <div class="section-title">
                        <span>ğŸ“ˆ å®æ—¶å¸‚åœºæ•°æ®</span>
                        <span class="last-update" id="lastUpdate">æœ€åæ›´æ–°: --</span>
                    </div>
                    <div class="data-card">
                        <div class="data-grid" id="marketData"></div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“Š ä»·æ ¼èµ°åŠ¿å›¾ï¼ˆå¤šæ—¶é—´æ¡†æ¶ï¼‰</div>
                    <div class="chart-tabs">
                        <div class="chart-tab active" onclick="switchChartTimeframe('1H')">1å°æ—¶Kçº¿</div>
                        <div class="chart-tab" onclick="switchChartTimeframe('4H')">4å°æ—¶Kçº¿</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ”¬ æŠ€æœ¯æŒ‡æ ‡åˆ†æï¼ˆå¤šæ—¶é—´æ¡†æ¶ï¼‰</div>
                    <div style="margin-bottom: 15px; font-weight: 600; color: #667eea;">1å°æ—¶çº§åˆ«æŒ‡æ ‡ï¼š</div>
                    <div class="data-card">
                        <div class="data-grid" id="indicators1H"></div>
                    </div>
                    <div style="margin: 25px 0 15px 0; font-weight: 600; color: #667eea;">4å°æ—¶çº§åˆ«æŒ‡æ ‡ï¼š</div>
                    <div class="data-card">
                        <div class="data-grid" id="indicators4H"></div>
                    </div>
                </div>

                <div class="ai-advice" id="aiAdviceSection" style="display: none;">
                    <div class="ai-advice-header">
                        <span class="ai-icon">ğŸ¤–</span>
                        <div>
                            <div class="ai-advice-title"><span id="aiProviderName">DeepSeek</span> AI äº¤æ˜“å»ºè®®</div>
                            <small style="color: #6c757d;">å¤šæ—¶é—´æ¡†æ¶ + å¤šçº§æ­¢ç›ˆæ­¢æŸ | <span id="aiUpdateTime">--</span></small>
                        </div>
                    </div>
                    <div class="advice-content" id="aiAdvice"></div>
                </div>
            </div>
        </div>

        <!-- å¤šå¸ç§é›·è¾¾ -->
        <div id="tab-multi" class="tab-content">
            <div class="section">
                <div class="section-title">ğŸ” å¤šå¸ç§é›·è¾¾æ‰«æ</div>
                <div class="config-section">
                    <div class="config-title">ğŸ’¡ åŠŸèƒ½è¯´æ˜</div>
                    <p>ä¸€é”®æ‰«æå¤šä¸ªå¸ç§ï¼Œé€šè¿‡æŠ€æœ¯æŒ‡æ ‡è¯„åˆ†æ‰¾å‡ºæœ€ä½³äº¤æ˜“æœºä¼šã€‚</p>
                </div>

                <div class="form-group">
                    <label>é€‰æ‹©è¦æ‰«æçš„å¸ç§ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div class="coin-selector" id="coinSelector"></div>
                </div>

                <div class="form-group">
                    <label>äº¤æ˜“ç±»å‹</label>
                    <select id="multiTradeType">
                        <option value="SWAP">æ°¸ç»­åˆçº¦</option>
                        <option value="SPOT">ç°è´§</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="startRadarScan()">
                        ğŸ¯ å¼€å§‹é›·è¾¾æ‰«æ
                    </button>
                </div>
            </div>

            <div id="radarLoading" class="loading">
                <div class="spinner"></div>
                <p style="color: #667eea; font-size: 1.2em; font-weight: 600;">æ­£åœ¨æ‰«æå¸ç§...</p>
                <p style="color: #6c757d; margin-top: 10px;" id="scanProgress">0/0</p>
            </div>

            <div id="radarResults" class="results">
                <div class="section">
                    <div class="section-title">ğŸ“Š æ‰«æç»“æœï¼ˆæŒ‰è¯„åˆ†æ’åºï¼‰</div>
                    <div class="comparison-grid" id="comparisonGrid"></div>
                </div>
            </div>
        </div>

        <!-- å†å²å›æµ‹ -->
        <div id="tab-backtest" class="tab-content">
            <div class="section">
                <div class="section-title">ğŸ“ˆ å†å²å›æµ‹</div>
                <div class="config-section">
                    <div class="config-title">ğŸ’¡ åŠŸèƒ½è¯´æ˜</div>
                    <p>åŸºäºå†å²æ•°æ®æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥è¡¨ç°ã€‚</p>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>å¸ç§ä»£ç </label>
                        <input type="text" id="backtestSymbol" placeholder="ä¾‹å¦‚: BTC" value="BTC">
                    </div>
                    <div class="form-group">
                        <label>å›æµ‹å‘¨æœŸ</label>
                        <select id="backtestPeriod">
                            <option value="7">æœ€è¿‘7å¤©</option>
                            <option value="30" selected>æœ€è¿‘30å¤©</option>
                            <option value="90">æœ€è¿‘90å¤©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åˆå§‹èµ„é‡‘ (USDT)</label>
                        <input type="number" id="backtestCapital" value="10000" min="100">
                    </div>
                    <div class="form-group">
                        <label>æ¯æ¬¡ä»“ä½æ¯”ä¾‹</label>
                        <select id="backtestPosition">
                            <option value="0.25">25%</option>
                            <option value="0.5" selected>50%</option>
                            <option value="0.75">75%</option>
                            <option value="1">100%</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startBacktest()">
                        ğŸš€ å¼€å§‹å›æµ‹
                    </button>
                </div>
            </div>

            <div id="backtestLoading" class="loading">
                <div class="spinner"></div>
                <p style="color: #667eea; font-size: 1.2em; font-weight: 600;">æ­£åœ¨å›æµ‹å†å²æ•°æ®...</p>
            </div>

            <div id="backtestResults" class="results">
                <div class="section">
                    <div class="section-title">ğŸ“Š å›æµ‹ç»“æœæ‘˜è¦</div>
                    <div class="backtest-summary" id="backtestSummary"></div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“ˆ æƒç›Šæ›²çº¿</div>
                    <div class="chart-container">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“ äº¤æ˜“è®°å½•</div>
                    <div class="trade-list" id="tradeList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let priceChart = null;
        let equityChart = null;
        let currentChartData = null;
        let currentTimeframe = '1H';
        let autoRefreshTimer = null;
        let isMonitoring = false;
        let lastMarketData = null;
        let nextUpdateTimeout = null;
        let currentAIProvider = 'deepseek';

        const popularCoins = ['BTC', 'ETH', 'SOL', 'BNB', 'XRP', 'DOGE', 'ADA', 'AVAX', 'DOT', 'MATIC', 'LINK', 'UNI', 'ATOM', 'LTC', 'BCH'];

        // AIæœåŠ¡å•†é€‰æ‹©
        function selectProvider(provider) {
            currentAIProvider = provider;
            document.getElementById('providerDeepseek').checked = (provider === 'deepseek');
            document.getElementById('providerQwen').checked = (provider === 'qwen');
            
            const label = document.getElementById('apiKeyLabel');
            const input = document.getElementById('apiKey');
            
            if (provider === 'deepseek') {
                label.textContent = 'DeepSeek API Key';
                input.placeholder = 'å¿…å¡«ï¼šsk-xxxxxx';
                document.getElementById('aiProviderName').textContent = 'DeepSeek';
            } else {
                label.textContent = 'é˜¿é‡Œäº‘åƒé—® API Key';
                input.placeholder = 'å¿…å¡«ï¼šsk-xxxxxx (é˜¿é‡Œäº‘)';
                document.getElementById('aiProviderName').textContent = 'åƒé—®';
            }
            
            const savedKey = localStorage.getItem(`${provider}ApiKey`);
            if (savedKey) {
                input.value = savedKey;
            }
        }

        // å·¥å…·å‡½æ•°
        function formatSignificantDigits(num, minDigits = 4) {
            if (num === 0) return '0';
            const absNum = Math.abs(num);
            if (absNum >= 1) {
                const integerDigits = Math.floor(Math.log10(absNum)) + 1;
                const decimalPlaces = Math.max(0, minDigits - integerDigits);
                return num.toFixed(decimalPlaces);
            }
            const magnitude = Math.floor(Math.log10(absNum));
            const decimalPlaces = minDigits - magnitude - 1;
            return num.toFixed(Math.max(0, decimalPlaces));
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function switchChartTimeframe(timeframe) {
            currentTimeframe = timeframe;
            document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            if (currentChartData) {
                if (timeframe === '1H') {
                    drawChart(currentChartData.timestamps1H, currentChartData.closes1H, 
                             currentChartData.ema20_1H, currentChartData.ema50_1H);
                } else {
                    drawChart(currentChartData.timestamps4H, currentChartData.closes4H, 
                             currentChartData.ema20_4H, currentChartData.ema50_4H);
                }
            }
        }

        function togglePositionDetails() {
            const status = document.getElementById('positionStatus').value;
            const details = document.getElementById('positionDetails');
            details.style.display = (status !== 'none') ? 'block' : 'none';
        }

        function resetForm() {
            stopMonitoring();
            document.getElementById('results').classList.remove('active');
            document.getElementById('positionStatus').value = 'none';
            togglePositionDetails();
        }

        function initCoinSelector() {
            const selector = document.getElementById('coinSelector');
            popularCoins.forEach(coin => {
                const chip = document.createElement('div');
                chip.className = 'coin-chip';
                chip.textContent = coin;
                chip.onclick = function() {
                    this.classList.toggle('selected');
                };
                selector.appendChild(chip);
            });
            selector.querySelectorAll('.coin-chip').forEach((chip, i) => {
                if (i < 5) chip.classList.add('selected');
            });
        }

        // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        async function startMonitoring() {
            const symbol = document.getElementById('symbol').value.toUpperCase().trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!symbol) {
                alert('è¯·è¾“å…¥å¸ç§ä»£ç ');
                return;
            }

            if (!apiKey) {
                alert('è¯·è¾“å…¥API Key');
                return;
            }

            document.getElementById('startBtn').disabled = true;
            document.getElementById('loading').classList.add('active');

            try {
                await updateMarketData();
                
                isMonitoring = true;
                document.getElementById('results').classList.add('active');
                document.getElementById('refreshControl').style.display = 'block';
                document.getElementById('aiBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('autoRefreshToggle').checked = true;
                
                toggleAutoRefresh();
                
            } catch (error) {
                console.error('å¯åŠ¨å¤±è´¥:', error);
                alert('å¯åŠ¨å¤±è´¥: ' + error.message);
                document.getElementById('startBtn').disabled = false;
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        function stopMonitoring() {
            isMonitoring = false;
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
            if (nextUpdateTimeout) {
                clearInterval(nextUpdateTimeout);
                nextUpdateTimeout = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('aiBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('autoRefreshToggle').checked = false;
            document.getElementById('refreshControl').style.display = 'none';
            document.getElementById('autoRefreshBadge').classList.remove('active');
            document.getElementById('refreshStatus').textContent = 'è‡ªåŠ¨æ›´æ–°å·²åœæ­¢';
            document.getElementById('nextUpdateTime').textContent = 'ä¸‹æ¬¡æ›´æ–°: --';
        }

        function toggleAutoRefresh() {
            const isEnabled = document.getElementById('autoRefreshToggle').checked;
            
            if (isEnabled && isMonitoring) {
                startAutoRefresh();
            } else {
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                    autoRefreshTimer = null;
                }
                if (nextUpdateTimeout) {
                    clearInterval(nextUpdateTimeout);
                    nextUpdateTimeout = null;
                }
                document.getElementById('autoRefreshBadge').classList.remove('active');
                document.getElementById('refreshStatus').textContent = 'è‡ªåŠ¨æ›´æ–°å·²æš‚åœ';
                document.getElementById('nextUpdateTime').textContent = 'ä¸‹æ¬¡æ›´æ–°: --';
            }
        }

        function startAutoRefresh() {
            const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
            
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            autoRefreshTimer = setInterval(() => {
                updateMarketData();
            }, interval);
            
            document.getElementById('autoRefreshBadge').classList.add('active');
            document.getElementById('refreshStatus').textContent = 'è‡ªåŠ¨æ›´æ–°è¿è¡Œä¸­';
            
            updateNextUpdateTime();
        }

        function updateRefreshInterval() {
            if (document.getElementById('autoRefreshToggle').checked) {
                startAutoRefresh();
            }
        }

        function updateNextUpdateTime() {
            if (nextUpdateTimeout) {
                clearInterval(nextUpdateTimeout);
            }
            
            const interval = parseInt(document.getElementById('refreshInterval').value);
            const nextTime = new Date(Date.now() + interval * 1000);
            
            const updateDisplay = () => {
                const now = new Date();
                const diff = Math.max(0, Math.floor((nextTime - now) / 1000));
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                document.getElementById('nextUpdateTime').textContent = 
                    `ä¸‹æ¬¡æ›´æ–°: ${minutes}åˆ†${seconds}ç§’`;
            };
            
            updateDisplay();
            nextUpdateTimeout = setInterval(updateDisplay, 1000);
        }

        async function updateMarketData() {
            const symbol = document.getElementById('symbol').value.toUpperCase().trim();
            const tradeType = document.getElementById('tradeType').value;
            const instId = tradeType === 'SPOT' ? `${symbol}-USDT` : `${symbol}-USDT-SWAP`;

            try {
                document.querySelectorAll('.data-item').forEach(item => {
                    item.classList.add('updating');
                });

                const [data1H, data4H] = await Promise.all([
                    fetchMarketData(instId, tradeType, '1H', 100),
                    fetchMarketData(instId, tradeType, '4H', 100)
                ]);

                lastMarketData = { data1H, data4H, symbol, tradeType };

                currentChartData = {
                    timestamps1H: data1H.timestamps,
                    closes1H: data1H.closes,
                    ema20_1H: data1H.ema20,
                    ema50_1H: data1H.ema50,
                    timestamps4H: data4H.timestamps,
                    closes4H: data4H.closes,
                    ema20_4H: data4H.ema20,
                    ema50_4H: data4H.ema50
                };

                displayMarketData({
                    symbol: symbol,
                    currentPrice: data1H.currentPrice,
                    change24h: data1H.change24h,
                    high24h: data1H.high24h,
                    low24h: data1H.low24h,
                    volume24h: data1H.volume24h,
                    fundingRate: data1H.fundingRate,
                    openInterest: data1H.openInterest
                });

                displayIndicators(data1H.indicators, '1H');
                displayIndicators(data4H.indicators, '4H');

                if (currentTimeframe === '1H') {
                    drawChart(data1H.timestamps, data1H.closes, data1H.ema20, data1H.ema50);
                } else {
                    drawChart(data4H.timestamps, data4H.closes, data4H.ema20, data4H.ema50);
                }

                document.getElementById('lastUpdate').textContent = 
                    `æœ€åæ›´æ–°: ${new Date().toLocaleTimeString('zh-CN')}`;

                setTimeout(() => {
                    document.querySelectorAll('.data-item').forEach(item => {
                        item.classList.remove('updating');
                    });
                }, 300);

                if (document.getElementById('autoRefreshToggle').checked) {
                    updateNextUpdateTime();
                }

            } catch (error) {
                console.error('æ›´æ–°å¸‚åœºæ•°æ®å¤±è´¥:', error);
            }
        }

        async function triggerAIAnalysis() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                alert('è¯·è¾“å…¥API Key');
                return;
            }

            if (!lastMarketData) {
                alert('è¯·å…ˆè·å–å¸‚åœºæ•°æ®');
                return;
            }

            document.getElementById('aiBtn').disabled = true;
            document.getElementById('loading').classList.add('active');

            try {
                await updateMarketData();

                const { data1H, data4H, symbol } = lastMarketData;
                const positionStatus = document.getElementById('positionStatus').value;

                let positionInfo = {
                    status: positionStatus,
                    entryPrice: null,
                    size: null,
                    leverage: null,
                    pnl: null,
                    pnlPercent: null
                };

                if (positionStatus !== 'none') {
                    positionInfo.entryPrice = parseFloat(document.getElementById('entryPrice').value);
                    positionInfo.size = parseFloat(document.getElementById('positionSize').value);
                    positionInfo.leverage = parseFloat(document.getElementById('leverage').value);
                    
                    if (positionStatus === 'long') {
                        positionInfo.pnl = (data1H.currentPrice - positionInfo.entryPrice) * positionInfo.size;
                        positionInfo.pnlPercent = ((data1H.currentPrice - positionInfo.entryPrice) / positionInfo.entryPrice * 100);
                    } else {
                        positionInfo.pnl = (positionInfo.entryPrice - data1H.currentPrice) * positionInfo.size;
                        positionInfo.pnlPercent = ((positionInfo.entryPrice - data1H.currentPrice) / positionInfo.entryPrice * 100);
                    }
                }

                const aiAdvice = await getAIAdvice({
                    symbol: symbol,
                    tradeType: lastMarketData.tradeType,
                    currentPrice: data1H.currentPrice,
                    marketData: {
                        change24h: data1H.change24h,
                        high24h: data1H.high24h,
                        low24h: data1H.low24h,
                        volume24h: data1H.volume24h,
                        fundingRate: data1H.fundingRate,
                        openInterest: data1H.openInterest
                    },
                    indicators1H: data1H.indicators,
                    indicators4H: data4H.indicators,
                    position: positionInfo,
                    recentPrices1H: data1H.closes.slice(-20),
                    recentPrices4H: data4H.closes.slice(-10)
                }, apiKey, currentAIProvider);

                displayAIAdvice(aiAdvice);
                document.getElementById('aiAdviceSection').style.display = 'block';
                document.getElementById('aiUpdateTime').textContent = 
                    `åˆ†ææ—¶é—´: ${new Date().toLocaleTimeString('zh-CN')}`;

            } catch (error) {
                console.error('AIåˆ†æå¤±è´¥:', error);
                alert('AIåˆ†æå¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('aiBtn').disabled = false;
            }
        }

        // æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
        function calculateEMA(data, period) {
            const k = 2 / (period + 1);
            let ema = [data[0]];
            for (let i = 1; i < data.length; i++) {
                ema.push(data[i] * k + ema[i - 1] * (1 - k));
            }
            return ema;
        }

        function calculateRSI(data, period) {
            let gains = [];
            let losses = [];
            
            for (let i = 1; i < data.length; i++) {
                const difference = data[i] - data[i - 1];
                gains.push(difference > 0 ? difference : 0);
                losses.push(difference < 0 ? -difference : 0);
            }
            
            if (gains.length < period) return [50];
            
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b) / period;
            
            if (avgLoss === 0) return [100];
            
            let rsi = [100 - (100 / (1 + avgGain / avgLoss))];
            
            for (let i = period; i < gains.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                rsi.push(avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss)));
            }
            
            return rsi;
        }

        function calculateMACD(data) {
            const ema12 = calculateEMA(data, 12);
            const ema26 = calculateEMA(data, 26);
            const macdLine = ema12.map((val, i) => val - ema26[i]);
            const signalLine = calculateEMA(macdLine, 9);
            const histogram = macdLine.map((val, i) => val - signalLine[i]);
            
            return {
                macd: macdLine[macdLine.length - 1],
                signal: signalLine[signalLine.length - 1],
                histogram: histogram[histogram.length - 1]
            };
        }

        function calculateATR(high, low, close, period) {
            let tr = [];
            for (let i = 1; i < high.length; i++) {
                const hl = high[i] - low[i];
                const hc = Math.abs(high[i] - close[i - 1]);
                const lc = Math.abs(low[i] - close[i - 1]);
                tr.push(Math.max(hl, hc, lc));
            }
            
            if (tr.length < period) return 0;
            
            let atr = tr.slice(0, period).reduce((a, b) => a + b) / period;
            for (let i = period; i < tr.length; i++) {
                atr = (atr * (period - 1) + tr[i]) / period;
            }
            
            return atr;
        }

        function calculateTechnicalScore(indicators, currentPrice) {
            let score = 50;
            
            if (currentPrice > indicators.ema20 && indicators.ema20 > indicators.ema50) {
                score += 15;
            } else if (currentPrice < indicators.ema20 && indicators.ema20 < indicators.ema50) {
                score -= 15;
            }
            
            if (indicators.rsi14 < 30) {
                score += 15;
            } else if (indicators.rsi14 > 70) {
                score -= 15;
            } else if (indicators.rsi14 >= 40 && indicators.rsi14 <= 60) {
                score += 5;
            }
            
            if (indicators.macd.histogram > 0 && indicators.macd.macd > indicators.macd.signal) {
                score += 10;
            } else if (indicators.macd.histogram < 0 && indicators.macd.macd < indicators.macd.signal) {
                score -= 10;
            }
            
            return Math.max(0, Math.min(100, score));
        }

        function getSignalFromScore(score) {
            if (score >= 70) return { text: 'å¼ºçƒˆåšå¤š', class: 'signal-buy' };
            if (score >= 55) return { text: 'å»ºè®®åšå¤š', class: 'signal-buy' };
            if (score >= 45) return { text: 'è§‚æœ›', class: 'signal-wait' };
            if (score >= 30) return { text: 'å»ºè®®åšç©º', class: 'signal-sell' };
            return { text: 'å¼ºçƒˆåšç©º', class: 'signal-sell' };
        }

        // æ•°æ®è·å–
        async function fetchMarketData(instId, tradeType, bar, limit) {
            const candlesResponse = await axios.get(`https://www.okx.com/api/v5/market/candles`, {
                params: { instId, bar, limit }
            });

            const candles = candlesResponse.data.data;
            if (!candles || candles.length === 0) {
                throw new Error('æ— æ³•è·å–Kçº¿æ•°æ®');
            }

            candles.reverse();
            const timestamps = candles.map(c => new Date(parseInt(c[0])));
            const opens = candles.map(c => parseFloat(c[1]));
            const highs = candles.map(c => parseFloat(c[2]));
            const lows = candles.map(c => parseFloat(c[3]));
            const closes = candles.map(c => parseFloat(c[4]));
            const volumes = candles.map(c => parseFloat(c[5]));

            const tickerResponse = await axios.get(`https://www.okx.com/api/v5/market/ticker`, {
                params: { instId }
            });
            const ticker = tickerResponse.data.data[0];
            const currentPrice = parseFloat(ticker.last);
            const open24h = parseFloat(ticker.sodUtc0);
            const change24h = open24h > 0 ? ((currentPrice - open24h) / open24h * 100) : 0;

            let fundingRate = 'N/A';
            if (tradeType !== 'SPOT') {
                try {
                    const fundingResponse = await axios.get(`https://www.okx.com/api/v5/public/funding-rate`, {
                        params: { instId }
                    });
                    fundingRate = (parseFloat(fundingResponse.data.data[0].fundingRate) * 100).toFixed(4) + '%';
                } catch (e) {}
            }

            let openInterest = 'N/A';
            if (tradeType !== 'SPOT') {
                try {
                    const oiResponse = await axios.get(`https://www.okx.com/api/v5/public/open-interest`, {
                        params: { instId }
                    });
                    openInterest = parseFloat(oiResponse.data.data[0].oi).toLocaleString();
                } catch (e) {}
            }

            const ema20 = calculateEMA(closes, 20);
            const ema50 = calculateEMA(closes, 50);
            const rsi7 = calculateRSI(closes, 7);
            const rsi14 = calculateRSI(closes, 14);
            const macd = calculateMACD(closes);
            const atr = calculateATR(highs, lows, closes, 14);

            return {
                timestamps, opens, highs, lows, closes, volumes,
                currentPrice, change24h,
                high24h: parseFloat(ticker.high24h),
                low24h: parseFloat(ticker.low24h),
                volume24h: parseFloat(ticker.vol24h),
                fundingRate, openInterest,
                ema20, ema50,
                indicators: {
                    ema20: ema20[ema20.length - 1],
                    ema50: ema50[ema50.length - 1],
                    rsi7: rsi7[rsi7.length - 1],
                    rsi14: rsi14[rsi14.length - 1],
                    macd: macd,
                    atr: atr
                }
            };
        }

        // æ•°æ®æ˜¾ç¤º
        function displayMarketData(data) {
            const container = document.getElementById('marketData');
            const changeClass = data.change24h >= 0 ? 'positive' : 'negative';
            const changeSymbol = data.change24h >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
            
            container.innerHTML = `
                <div class="data-item">
                    <div class="data-label">å½“å‰ä»·æ ¼</div>
                    <div class="data-value">${formatSignificantDigits(data.currentPrice, 4)} USDT</div>
                </div>
                <div class="data-item">
                    <div class="data-label">24å°æ—¶æ¶¨è·Œ ${changeSymbol}</div>
                    <div class="data-value ${changeClass}">${data.change24h.toFixed(2)}%</div>
                </div>
                <div class="data-item">
                    <div class="data-label">24å°æ—¶æœ€é«˜</div>
                    <div class="data-value">${formatSignificantDigits(data.high24h, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">24å°æ—¶æœ€ä½</div>
                    <div class="data-value">${formatSignificantDigits(data.low24h, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">24å°æ—¶æˆäº¤é‡</div>
                    <div class="data-value">${data.volume24h.toFixed(2)} ${data.symbol}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">èµ„é‡‘è´¹ç‡</div>
                    <div class="data-value">${data.fundingRate}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">æŒä»“é‡</div>
                    <div class="data-value">${data.openInterest}</div>
                </div>
            `;
        }

        function displayIndicators(data, timeframe) {
            const container = document.getElementById('indicators' + timeframe);
            const rsi7Class = data.rsi7 > 70 ? 'negative' : data.rsi7 < 30 ? 'positive' : '';
            const rsi14Class = data.rsi14 > 70 ? 'negative' : data.rsi14 < 30 ? 'positive' : '';
            
            container.innerHTML = `
                <div class="data-item">
                    <div class="data-label">EMA(20)</div>
                    <div class="data-value">${formatSignificantDigits(data.ema20, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">EMA(50)</div>
                    <div class="data-value">${formatSignificantDigits(data.ema50, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">RSI(7)</div>
                    <div class="data-value ${rsi7Class}">${data.rsi7.toFixed(2)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">RSI(14)</div>
                    <div class="data-value ${rsi14Class}">${data.rsi14.toFixed(2)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">MACD</div>
                    <div class="data-value">${formatSignificantDigits(data.macd.macd, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">MACDä¿¡å·çº¿</div>
                    <div class="data-value">${formatSignificantDigits(data.macd.signal, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">MACDæŸ±çŠ¶å›¾</div>
                    <div class="data-value ${data.macd.histogram > 0 ? 'positive' : 'negative'}">${formatSignificantDigits(data.macd.histogram, 4)}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">ATR(14)</div>
                    <div class="data-value">${formatSignificantDigits(data.atr, 4)}</div>
                </div>
            `;
        }

        function drawChart(timestamps, closes, ema20, ema50) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps.map(t => t.toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit' })),
                    datasets: [
                        {
                            label: 'ä»·æ ¼',
                            data: closes,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'EMA(20)',
                            data: ema20,
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'EMA(50)',
                            data: ema50,
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: 'ä»·æ ¼èµ°åŠ¿ä¸å‡çº¿' }
                    },
                    scales: { y: { beginAtZero: false } }
                }
            });
        }

        // AIåˆ†æï¼ˆæ”¹è¿›ç‰ˆï¼‰
        async function getAIAdvice(data, apiKey, provider) {
            const atr1H = data.indicators1H.atr;
            const atr4H = data.indicators4H.atr;
            
            // è®¡ç®—å…³é”®ä»·æ ¼ä½
            const currentPrice = data.currentPrice;
            const high24h = data.marketData.high24h;
            const low24h = data.marketData.low24h;
            const ema20_1H = data.indicators1H.ema20;
            const ema50_1H = data.indicators1H.ema50;
            const ema20_4H = data.indicators4H.ema20;
            const ema50_4H = data.indicators4H.ema50;
            
            let prompt = `ä½ æ˜¯ä¸€åç»éªŒä¸°å¯Œçš„æ¿€è¿›çš„ä¸“ä¸šäº¤æ˜“å‘˜ï¼Œæ­£åœ¨ç”¨è‡ªå·±çš„èµ„é‡‘äº¤æ˜“${data.symbol}ã€‚ç°åœ¨éœ€è¦ä½ åšå‡ºçœŸå®çš„äº¤æ˜“å†³ç­–ï¼Œè¯­è¨€ç®€ç»ƒï¼Œä¸è¦è¯´å®¢å¥—è¯

=== å¸‚åœºæ•°æ® ===
å½“å‰ä»·æ ¼: ${formatSignificantDigits(currentPrice, 4)} USDT
24Hå˜åŒ–: ${data.marketData.change24h.toFixed(2)}%
24Hé«˜ç‚¹: ${formatSignificantDigits(high24h, 4)} | ä½ç‚¹: ${formatSignificantDigits(low24h, 4)}
ATR(1H): ${formatSignificantDigits(atr1H, 4)} | ATR(4H): ${formatSignificantDigits(atr4H, 4)}

=== æŠ€æœ¯æŒ‡æ ‡ ===
ã€1å°æ—¶çº§åˆ«ã€‘
- EMA20: ${formatSignificantDigits(ema20_1H, 4)} | EMA50: ${formatSignificantDigits(ema50_1H, 4)}
- RSI: ${data.indicators1H.rsi14.toFixed(2)} | MACDæŸ±: ${formatSignificantDigits(data.indicators1H.macd.histogram, 4)}

ã€4å°æ—¶çº§åˆ«ã€‘
- EMA20: ${formatSignificantDigits(ema20_4H, 4)} | EMA50: ${formatSignificantDigits(ema50_4H, 4)}
- RSI: ${data.indicators4H.rsi14.toFixed(2)} | MACDæŸ±: ${formatSignificantDigits(data.indicators4H.macd.histogram, 4)}

=== è¿‘æœŸä»·æ ¼è¡Œä¸º ===
æœ€è¿‘20æ ¹1H Kçº¿æ”¶ç›˜ä»·: ${data.recentPrices1H.slice(-5).map(p => formatSignificantDigits(p, 4)).join(', ')}...
æœ€è¿‘10æ ¹4H Kçº¿æ”¶ç›˜ä»·: ${data.recentPrices4H.slice(-3).map(p => formatSignificantDigits(p, 4)).join(', ')}...
`;

            if (data.position.status !== 'none') {
                const posType = data.position.status === 'long' ? 'å¤šå¤´' : 'ç©ºå¤´';
                const pnl = data.position.pnlPercent.toFixed(2);
                const entryPrice = data.position.entryPrice;
                
                prompt += `
=== å½“å‰æŒä»“ ===
æ–¹å‘: ${posType}
å¼€ä»“ä»·: ${formatSignificantDigits(entryPrice, 4)} USDT
æŒä»“: ${data.position.size} ${data.symbol}
æ æ†: ${data.position.leverage}x
æµ®åŠ¨ç›ˆäº: ${pnl}%

ä½œä¸ºäº¤æ˜“å‘˜ï¼Œä½ ç°åœ¨å¿…é¡»åšå‡ºå†³ç­–ï¼š

ã€åˆ†ææ­¥éª¤ã€‘
1. è¶‹åŠ¿åˆ¤æ–­ï¼š1Hå’Œ4Hçš„EMAæ’åˆ—æ˜¯å¦ä¸€è‡´ï¼Ÿå½“å‰å¤„äºä»€ä¹ˆè¶‹åŠ¿é˜¶æ®µï¼Ÿ
2. åŠ¨èƒ½åˆ†æï¼šMACDå’ŒRSIæ˜¾ç¤ºåŠ¨èƒ½æ˜¯å¢å¼ºè¿˜æ˜¯è¡°å‡ï¼Ÿ
3. å…³é”®ä»·ä½ï¼š
   - å‘ä¸Šå‹åŠ›ä½ï¼š24Hé«˜ç‚¹${formatSignificantDigits(high24h, 4)}ã€4H EMA20/50
   - å‘ä¸‹æ”¯æ’‘ä½ï¼š24Hä½ç‚¹${formatSignificantDigits(low24h, 4)}ã€1H EMA20/50
4. ç›ˆäºæƒ…å†µï¼šå½“å‰${pnl}%çš„æµ®ç›ˆ/æµ®äºæ˜¯å¦åº”è¯¥å…‘ç°æˆ–æ­¢æŸï¼Ÿ

ã€å†³ç­–ã€‘ï¼ˆå¿…é¡»æ˜ç¡®é€‰ä¸€ä¸ªï¼‰
â–¡ ç»§ç»­æŒæœ‰
â–¡ éƒ¨åˆ†æ­¢ç›ˆ
â–¡ å…¨éƒ¨æ­¢ç›ˆ
â–¡ æ­¢æŸç¦»åœº
â–¡ åŠ ä»“

ã€æ‰§è¡Œè®¡åˆ’ã€‘
ä¸‰çº§æ­¢ç›ˆæ–¹æ¡ˆï¼ˆç»“åˆå…³é”®å‹åŠ›ä½å’ŒATRï¼‰ï¼š
- ç¬¬ä¸€ç›®æ ‡ï¼ˆ30%ä»“ä½ï¼‰: [ä»·æ ¼] - ç†ç”±ï¼š[å…³é”®ä½ç½®/ATRå€æ•°]
- ç¬¬äºŒç›®æ ‡ï¼ˆ40%ä»“ä½ï¼‰: [ä»·æ ¼] - ç†ç”±ï¼š[å…³é”®ä½ç½®/ATRå€æ•°]  
- ç¬¬ä¸‰ç›®æ ‡ï¼ˆ30%ä»“ä½ï¼‰: [ä»·æ ¼] - ç†ç”±ï¼š[å…³é”®ä½ç½®/ATRå€æ•°]

æ­¢æŸä½ï¼š[ä»·æ ¼] - å¿…é¡»è¯´æ˜æ˜¯åŸºäºä»€ä¹ˆï¼ˆå…³é”®æ”¯æ’‘ä½/1.5-2å€ATR/ä¿æŠ¤åˆ©æ¶¦ï¼‰

ã€æ ¸å¿ƒé€»è¾‘ã€‘ï¼ˆ1-2å¥è¯ï¼‰
ä¸ºä»€ä¹ˆåšè¿™ä¸ªå†³ç­–ï¼Ÿå¤šç©ºå…±æŒ¯ï¼Ÿè¶‹åŠ¿å»¶ç»­ï¼Ÿè¿˜æ˜¯èƒŒç¦»ä¿¡å·ï¼Ÿ
`;
            } else {
                prompt += `
=== å½“å‰çŠ¶æ€ ===
æœªæŒä»“ï¼Œæ­£åœ¨å¯»æ‰¾å…¥åœºæœºä¼šã€‚

ä½œä¸ºäº¤æ˜“å‘˜ï¼Œä½ å¿…é¡»è¯„ä¼°å½“å‰ä»·æ ¼æ˜¯å¦åº”è¯¥å…¥åœºï¼š

ã€åˆ†ææ­¥éª¤ã€‘
1. å¤šç©ºåˆ¤æ–­ï¼š
   - 1Hçº§åˆ«ï¼šä»·æ ¼vs EMA20 vs EMA50çš„ä½ç½®å…³ç³»
   - 4Hçº§åˆ«ï¼šä»·æ ¼vs EMA20 vs EMA50çš„ä½ç½®å…³ç³»
   - åŒå‘¨æœŸæ˜¯å¦å…±æŒ¯ï¼Ÿ

2. åŠ¨èƒ½ç¡®è®¤ï¼š
   - RSIæ˜¯å¦è¶…ä¹°/è¶…å–/ä¸­æ€§ï¼Ÿ
   - MACDæŸ±æ˜¯å¦æ”¾å¤§/æ”¶ç¼©ï¼Ÿ
   - ä»·æ ¼åŠ¨èƒ½æ˜¯å¦ä¸æŒ‡æ ‡èƒŒç¦»ï¼Ÿ

3. å…³é”®ä»·ä½è¯†åˆ«ï¼š
   - å‹åŠ›ä½ï¼š24Hé«˜ç‚¹${formatSignificantDigits(high24h, 4)}ã€EMAå‡çº¿
   - æ”¯æ’‘ä½ï¼š24Hä½ç‚¹${formatSignificantDigits(low24h, 4)}ã€EMAå‡çº¿
   - å½“å‰ä»·æ ¼ç¦»å“ªä¸ªå…³é”®ä½æ›´è¿‘ï¼Ÿ

4. é£é™©æ”¶ç›Šæ¯”ï¼š
   - å…¥åœºåˆ°ç¬¬ä¸€ç›®æ ‡çš„ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Ÿ
   - æ­¢æŸè·ç¦»æ˜¯å¦åˆç†ï¼ˆä¸è¶…è¿‡2å€ATRï¼‰ï¼Ÿ

ã€å†³ç­–ã€‘ï¼ˆå¿…é¡»æ˜ç¡®é€‰ä¸€ä¸ªï¼‰
â–¡ åšå¤š
â–¡ åšç©º
â–¡ è§‚æœ›ç­‰å¾…

å¦‚æœã€åšå¤šã€‘æˆ–ã€åšç©ºã€‘ï¼Œæä¾›ï¼š

å…¥åœºç­–ç•¥ï¼š
- å½“å‰ä»·æ ¼çš„å…¥åœºåŒºé—´ï¼š[ä»·æ ¼1] - [ä»·æ ¼2]ï¼ˆåŸºäºå›è°ƒ/çªç ´+ATRï¼‰

ä¸‰çº§æ­¢ç›ˆï¼ˆç»“åˆå…³é”®å‹åŠ›ä½/æ”¯æ’‘ä½å’ŒATRï¼‰ï¼š
- ä¿å®ˆç›®æ ‡ï¼ˆ30%ï¼‰: [ä»·æ ¼] - [å‹åŠ›ä½/æ”¯æ’‘ä½ + ATRå€æ•°]
- ä¸­æ€§ç›®æ ‡ï¼ˆ40%ï¼‰: [ä»·æ ¼] - [ä¸‹ä¸€ä¸ªå…³é”®ä½ + ATRå€æ•°]
- æ¿€è¿›ç›®æ ‡ï¼ˆ30%ï¼‰: [ä»·æ ¼] - [é‡è¦å¿ƒç†å…³å£ + ATRå€æ•°]

æ­¢æŸä½ï¼š[ä»·æ ¼] - åŸºäº[å…³é”®æ”¯æ’‘/å‹åŠ›ä½]æˆ–[1.5-2å€ATR]

å¦‚æœã€è§‚æœ›ã€‘ï¼Œè¯´æ˜ï¼š
- ç­‰å¾…ä»€ä¹ˆä¿¡å·ï¼Ÿï¼ˆçªç ´ã€å›è°ƒã€æŒ‡æ ‡ä¿®å¤ï¼‰
- å…³æ³¨å“ªä¸ªä»·ä½ï¼Ÿï¼ˆçªç ´åšå¤š / è·Œç ´åšç©ºï¼‰
- å…·ä½“è§¦å‘æ¡ä»¶

ã€æ ¸å¿ƒé€»è¾‘ã€‘ï¼ˆ2-3å¥è¯ï¼‰
ä¸ºä»€ä¹ˆåšå¤š/åšç©º/è§‚æœ›ï¼Ÿå¤šç©ºè¶‹åŠ¿å¦‚ä½•ï¼Ÿå…³é”®ä½åœ¨å“ªï¼Ÿ1Hå’Œ4Hæ˜¯å¦å…±æŒ¯ï¼Ÿ
`;
            }

            prompt += `
ã€å›å¤è¦æ±‚ã€‘
1. åƒä¸€ä¸ªæ¿€è¿›çš„ä¸“ä¸šäº¤æ˜“å‘˜ä¸€æ ·æ€è€ƒå’Œå†³ç­–
2. ä»·æ ¼å¿…é¡»å…·ä½“ä¸”åˆç†ï¼ŒåŸºäºå½“å‰ä»·æ ¼è¿›è¡Œå†³ç­–ï¼š
   - æ­¢ç›ˆä½è¦è€ƒè™‘å…³é”®å‹åŠ›ä½/æ”¯æ’‘ä½ï¼Œä¸èƒ½åªçœ‹ATR
   - æ­¢æŸä½è¦ä¿æŠ¤æœ¬é‡‘æˆ–åˆ©æ¶¦ï¼Œè®¾åœ¨å…³é”®ä½é™„è¿‘
3. ä¸‰çº§æ­¢ç›ˆé—´éš”è¦å¤Ÿå¤§ï¼ˆ3-5å€ATRæˆ–å…³é”®ä½ä¹‹é—´çš„è·ç¦»ï¼‰
4. è¯´æ˜æ¯ä¸ªä»·ä½çš„ä¾æ®ï¼ˆæ˜¯EMAï¼Ÿæ˜¯24Hé«˜ä½ç‚¹ï¼Ÿè¿˜æ˜¯ATRå€æ•°ï¼Ÿï¼‰
5. ä¸è¦å®¢å¥—è¯ï¼Œç›´æ¥ç»™å†³ç­–å’Œç†ç”±
6. è¦ä½“ç°å¯¹å¸‚åœºç»“æ„çš„ç†è§£ï¼ˆè¶‹åŠ¿ã€æ”¯æ’‘å‹åŠ›ã€åŠ¨èƒ½ï¼‰`;

            try {
                let apiUrl, modelName, headers;
                
                if (provider === 'deepseek') {
                    apiUrl = 'https://api.deepseek.com/v1/chat/completions';
                    modelName = 'deepseek-chat';
                    headers = {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    };
                } else {
                    apiUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
                    modelName = 'qwen-plus';
                    headers = {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    };
                }

                const response = await axios.post(apiUrl, {
                    model: modelName,
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸€åé¡¶å°–çš„åŠ å¯†è´§å¸äº¤æ˜“å‘˜ï¼Œæ‹¥æœ‰10å¹´å®æˆ˜ç»éªŒã€‚ä½ æ“…é•¿å¤šæ—¶é—´æ¡†æ¶åˆ†æã€è¯†åˆ«å…³é”®ä»·æ ¼ä½ã€åˆ¤æ–­å¸‚åœºç»“æ„ã€‚ä½ ç”¨è‡ªå·±çš„èµ„é‡‘äº¤æ˜“ï¼Œæ¯ä¸ªå†³ç­–éƒ½æ˜¯çœŸé‡‘ç™½é“¶ã€‚ä½ çš„é£æ ¼ï¼šæœæ–­ã€ç²¾å‡†ã€æ¿€è¿›ï¼Œä»ä¸æ¨¡æ£±ä¸¤å¯ã€‚'
                        },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                }, { headers });

                return response.data.choices[0].message.content;
            } catch (error) {
                console.error('AI APIè°ƒç”¨å¤±è´¥:', error);
                throw new Error('AIåˆ†æå¤±è´¥: ' + (error.response?.data?.error?.message || error.message));
            }
        }

        function displayAIAdvice(advice) {
            const container = document.getElementById('aiAdvice');
            
            let signal = '';
            const lowerAdvice = advice.toLowerCase();
            
            if (lowerAdvice.includes('åšå¤š') || lowerAdvice.includes('ä¹°å…¥')) {
                signal = '<span class="signal-badge signal-buy">ğŸ“ˆ åšå¤š</span>';
            } else if (lowerAdvice.includes('åšç©º') || lowerAdvice.includes('å–å‡º')) {
                signal = '<span class="signal-badge signal-sell">ğŸ“‰ åšç©º</span>';
            } else if (lowerAdvice.includes('ç»§ç»­æŒæœ‰') || lowerAdvice.includes('æŒæœ‰')) {
                signal = '<span class="signal-badge signal-hold">â¸ï¸ æŒæœ‰</span>';
            } else if (lowerAdvice.includes('æ­¢ç›ˆ')) {
                signal = '<span class="signal-badge signal-buy">ğŸ’° æ­¢ç›ˆ</span>';
            } else if (lowerAdvice.includes('æ­¢æŸ')) {
                signal = '<span class="signal-badge signal-sell">ğŸ›‘ æ­¢æŸ</span>';
            } else if (lowerAdvice.includes('è§‚æœ›')) {
                signal = '<span class="signal-badge signal-wait">ğŸ‘€ è§‚æœ›</span>';
            }
            
            container.innerHTML = signal + '<br><br>' + advice.replace(/\n/g, '<br>');
        }

        // å¤šå¸ç§é›·è¾¾
        async function startRadarScan() {
            const selectedCoins = Array.from(document.querySelectorAll('.coin-chip.selected')).map(chip => chip.textContent);
            
            if (selectedCoins.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¸ç§');
                return;
            }

            const tradeType = document.getElementById('multiTradeType').value;

            document.getElementById('radarLoading').classList.add('active');
            document.getElementById('radarResults').classList.remove('active');

            const results = [];
            let completed = 0;

            for (const coin of selectedCoins) {
                try {
                    const instId = tradeType === 'SPOT' ? `${coin}-USDT` : `${coin}-USDT-SWAP`;
                    const data = await fetchMarketData(instId, tradeType, '1H', 100);
                    
                    const score = calculateTechnicalScore(data.indicators, data.currentPrice);
                    const signal = getSignalFromScore(score);
                    
                    results.push({
                        coin, score, signal,
                        currentPrice: data.currentPrice,
                        change24h: data.change24h,
                        indicators: data.indicators
                    });

                    completed++;
                    document.getElementById('scanProgress').textContent = `${completed}/${selectedCoins.length}`;
                } catch (error) {
                    console.error(`æ‰«æ${coin}å¤±è´¥:`, error);
                }
            }

            results.sort((a, b) => b.score - a.score);
            displayRadarResults(results);

            document.getElementById('radarLoading').classList.remove('active');
            document.getElementById('radarResults').classList.add('active');
        }

        function displayRadarResults(results) {
            const container = document.getElementById('comparisonGrid');
            
            container.innerHTML = results.map(result => {
                const scoreColor = result.score >= 70 ? '#28a745' : 
                                   result.score >= 55 ? '#17a2b8' : 
                                   result.score >= 45 ? '#ffc107' : 
                                   result.score >= 30 ? '#fd7e14' : '#dc3545';
                
                return `
                    <div class="coin-card">
                        <div class="coin-card-header">
                            <div class="coin-name">${result.coin}</div>
                            <div class="coin-signal ${result.signal.class}">${result.signal.text}</div>
                        </div>
                        
                        <div class="score-container">
                            <div class="score-circle" style="background: linear-gradient(135deg, ${scoreColor}, ${scoreColor}88); color: white;">
                                ${result.score}
                            </div>
                            <div class="score-label">æŠ€æœ¯è¯„åˆ†</div>
                        </div>
                        
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">å½“å‰ä»·æ ¼</div>
                                <div class="data-value">${formatSignificantDigits(result.currentPrice, 4)}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">24hæ¶¨è·Œ</div>
                                <div class="data-value ${result.change24h >= 0 ? 'positive' : 'negative'}">
                                    ${result.change24h.toFixed(2)}%
                                </div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">RSI(14)</div>
                                <div class="data-value">${result.indicators.rsi14.toFixed(2)}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">MACD</div>
                                <div class="data-value ${result.indicators.macd.histogram > 0 ? 'positive' : 'negative'}">
                                    ${formatSignificantDigits(result.indicators.macd.histogram, 4)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // å†å²å›æµ‹
        async function startBacktest() {
            const symbol = document.getElementById('backtestSymbol').value.toUpperCase().trim();
            const period = parseInt(document.getElementById('backtestPeriod').value);
            const capital = parseFloat(document.getElementById('backtestCapital').value);
            const positionSize = parseFloat(document.getElementById('backtestPosition').value);

            if (!symbol) {
                alert('è¯·è¾“å…¥å¸ç§ä»£ç ');
                return;
            }

            document.getElementById('backtestLoading').classList.add('active');
            document.getElementById('backtestResults').classList.remove('active');

            try {
                const instId = `${symbol}-USDT-SWAP`;
                const response = await axios.get(`https://www.okx.com/api/v5/market/history-candles`, {
                    params: {
                        instId: instId,
                        bar: '4H',
                        limit: Math.min(period * 6, 100)
                    }
                });

                const candles = response.data.data;
                if (!candles || candles.length === 0) {
                    throw new Error('æ— æ³•è·å–å†å²æ•°æ®');
                }

                candles.reverse();
                const closes = candles.map(c => parseFloat(c[4]));
                const timestamps = candles.map(c => new Date(parseInt(c[0])));
                const ema20 = calculateEMA(closes, 20);
                const ema50 = calculateEMA(closes, 50);
                const backtestResult = runBacktest(closes, ema20, ema50, capital, positionSize, timestamps);

                displayBacktestResults(backtestResult);

                document.getElementById('backtestLoading').classList.remove('active');
                document.getElementById('backtestResults').classList.add('active');

            } catch (error) {
                console.error('å›æµ‹å¤±è´¥:', error);
                alert('å›æµ‹å¤±è´¥: ' + error.message);
                document.getElementById('backtestLoading').classList.remove('active');
            }
        }

        function runBacktest(closes, ema20, ema50, initialCapital, positionSize, timestamps) {
            let capital = initialCapital;
            let position = null;
            let trades = [];
            let equityCurve = [initialCapital];
            let winCount = 0;
            let lossCount = 0;
            let totalProfit = 0;
            let totalLoss = 0;

            for (let i = 50; i < closes.length; i++) {
                const currentPrice = closes[i];
                const prevEma20 = ema20[i - 1];
                const prevEma50 = ema50[i - 1];
                const currEma20 = ema20[i];
                const currEma50 = ema50[i];

                if (!position) {
                    if (prevEma20 <= prevEma50 && currEma20 > currEma50) {
                        const amount = capital * positionSize;
                        const quantity = amount / currentPrice;
                        position = {
                            type: 'long',
                            entryPrice: currentPrice,
                            quantity: quantity,
                            entryTime: timestamps[i]
                        };
                    } else if (prevEma20 >= prevEma50 && currEma20 < currEma50) {
                        const amount = capital * positionSize;
                        const quantity = amount / currentPrice;
                        position = {
                            type: 'short',
                            entryPrice: currentPrice,
                            quantity: quantity,
                            entryTime: timestamps[i]
                        };
                    }
                } else {
                    let shouldClose = false;
                    
                    if (position.type === 'long' && prevEma20 >= prevEma50 && currEma20 < currEma50) {
                        shouldClose = true;
                    } else if (position.type === 'short' && prevEma20 <= prevEma50 && currEma20 > currEma50) {
                        shouldClose = true;
                    }

                    if (shouldClose) {
                        let pnl = 0;
                        if (position.type === 'long') {
                            pnl = (currentPrice - position.entryPrice) * position.quantity;
                        } else {
                            pnl = (position.entryPrice - currentPrice) * position.quantity;
                        }

                        const pnlPercent = (pnl / (position.entryPrice * position.quantity)) * 100;
                        capital += pnl;

                        if (pnl > 0) {
                            winCount++;
                            totalProfit += pnl;
                        } else {
                            lossCount++;
                            totalLoss += Math.abs(pnl);
                        }

                        trades.push({
                            type: position.type,
                            entryPrice: position.entryPrice,
                            exitPrice: currentPrice,
                            entryTime: position.entryTime,
                            exitTime: timestamps[i],
                            pnl: pnl,
                            pnlPercent: pnlPercent
                        });

                        position = null;
                    }
                }

                let currentEquity = capital;
                if (position) {
                    if (position.type === 'long') {
                        currentEquity += (currentPrice - position.entryPrice) * position.quantity;
                    } else {
                        currentEquity += (position.entryPrice - currentPrice) * position.quantity;
                    }
                }
                equityCurve.push(currentEquity);
            }

            const totalTrades = trades.length;
            const winRate = totalTrades > 0 ? (winCount / totalTrades * 100) : 0;
            const avgProfit = winCount > 0 ? totalProfit / winCount : 0;
            const avgLoss = lossCount > 0 ? totalLoss / lossCount : 0;
            const profitFactor = totalLoss > 0 ? totalProfit / totalLoss : 0;
            const finalReturn = ((capital - initialCapital) / initialCapital * 100);

            return {
                initialCapital, finalCapital: capital, totalReturn: finalReturn,
                totalTrades, winCount, lossCount, winRate,
                avgProfit, avgLoss, profitFactor,
                trades, equityCurve, timestamps
            };
        }

        function displayBacktestResults(result) {
            const summary = document.getElementById('backtestSummary');
            summary.innerHTML = `
                <div class="backtest-metric">
                    <div class="backtest-metric-label">åˆå§‹èµ„é‡‘</div>
                    <div class="backtest-metric-value">$${result.initialCapital.toLocaleString()}</div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">æœ€ç»ˆèµ„é‡‘</div>
                    <div class="backtest-metric-value" style="color: ${result.finalCapital >= result.initialCapital ? '#28a745' : '#dc3545'}">
                        $${result.finalCapital.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">æ€»æ”¶ç›Šç‡</div>
                    <div class="backtest-metric-value" style="color: ${result.totalReturn >= 0 ? '#28a745' : '#dc3545'}">
                        ${result.totalReturn.toFixed(2)}%
                    </div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">äº¤æ˜“æ¬¡æ•°</div>
                    <div class="backtest-metric-value">${result.totalTrades}</div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">èƒœç‡</div>
                    <div class="backtest-metric-value" style="color: ${result.winRate >= 50 ? '#28a745' : '#dc3545'}">
                        ${result.winRate.toFixed(1)}%
                    </div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">ç›ˆåˆ©å› å­</div>
                    <div class="backtest-metric-value" style="color: ${result.profitFactor >= 1 ? '#28a745' : '#dc3545'}">
                        ${result.profitFactor.toFixed(2)}
                    </div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">å¹³å‡ç›ˆåˆ©</div>
                    <div class="backtest-metric-value positive">$${result.avgProfit.toFixed(2)}</div>
                </div>
                <div class="backtest-metric">
                    <div class="backtest-metric-label">å¹³å‡äºæŸ</div>
                    <div class="backtest-metric-value negative">$${result.avgLoss.toFixed(2)}</div>
                </div>
            `;

            drawEquityCurve(result.equityCurve, result.timestamps);

            const tradeList = document.getElementById('tradeList');
            tradeList.innerHTML = result.trades.map((trade, index) => `
                <div class="trade-item ${trade.pnl > 0 ? 'profit' : 'loss'}">
                    <div>
                        <strong>#${index + 1}</strong> 
                        ${trade.type === 'long' ? 'ğŸ“ˆ åšå¤š' : 'ğŸ“‰ åšç©º'}
                        <br>
                        <small>${trade.entryTime.toLocaleString('zh-CN', {month: 'short', day: 'numeric', hour: '2-digit'})}</small>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.2em; font-weight: 700; color: ${trade.pnl > 0 ? '#28a745' : '#dc3545'}">
                            ${trade.pnl > 0 ? '+' : ''}$${trade.pnl.toFixed(2)}
                        </div>
                        <small>${trade.pnlPercent > 0 ? '+' : ''}${trade.pnlPercent.toFixed(2)}%</small>
                    </div>
                </div>
            `).join('');
        }

        function drawEquityCurve(equityCurve, timestamps) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            if (equityChart) {
                equityChart.destroy();
            }

            const labels = [];
            for (let i = 0; i < equityCurve.length; i++) {
                if (i < timestamps.length) {
                    labels.push(timestamps[i].toLocaleString('zh-CN', {month: 'short', day: 'numeric'}));
                } else {
                    labels.push('');
                }
            }

            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è´¦æˆ·æƒç›Š',
                        data: equityCurve,
                        borderColor: equityCurve[equityCurve.length - 1] >= equityCurve[0] ? 'rgb(40, 167, 69)' : 'rgb(220, 53, 69)',
                        backgroundColor: equityCurve[equityCurve.length - 1] >= equityCurve[0] ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: 'è´¦æˆ·æƒç›Šå˜åŒ–æ›²çº¿' }
                    },
                    scales: { y: { beginAtZero: false } }
                }
            });
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            const savedDeepseekKey = localStorage.getItem('deepseekApiKey');
            const savedQwenKey = localStorage.getItem('qwenApiKey');
            
            if (savedDeepseekKey && currentAIProvider === 'deepseek') {
                document.getElementById('apiKey').value = savedDeepseekKey;
            } else if (savedQwenKey && currentAIProvider === 'qwen') {
                document.getElementById('apiKey').value = savedQwenKey;
            }
            
            initCoinSelector();
        };

        document.getElementById('apiKey').addEventListener('change', function() {
            localStorage.setItem(`${currentAIProvider}ApiKey`, this.value);
        });

        document.querySelectorAll('input[name="aiProvider"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const provider = this.value;
                selectProvider(provider);
            });
        });

        window.addEventListener('beforeunload', () => {
            stopMonitoring();
        });
    </script>
</body>
</html>
